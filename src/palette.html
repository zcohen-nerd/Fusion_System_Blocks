<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>System Blocks</title>
  <style>
    html, body { height:100%; margin:0; font-family: system-ui, sans-serif; }
    
    header { 
      padding: 8px 12px; 
      background: #f0f0f0; 
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .toolbar {
      display: flex;
      gap: 8px;
    }
    
    .toolbar button {
      padding: 6px 12px;
      border: 1px solid #999;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .toolbar button:hover {
      background: #e6e6e6;
    }
    
    .toolbar button.toggle-btn.active {
      background: #0066cc;
      color: white;
    }
    
    .toolbar button.toggle-btn:hover {
      background: #0052a3;
    }
    
    .toolbar .separator {
      width: 1px;
      height: 20px;
      background: #ccc;
      margin: 0 4px;
    }
    
    .toolbar button.context-btn:disabled {
      background: #f5f5f5;
      color: #999;
      cursor: not-allowed;
    }
    
    .toolbar button.context-btn:not(:disabled):hover {
      background: #e6f3ff;
      border-color: #0066cc;
    }
    
    .connection-type-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .connection-type-select {
      padding: 4px 8px;
      border: 1px solid #999;
      border-radius: 3px;
      font-size: 12px;
      background: white;
      cursor: pointer;
    }
    
    .connection-type-select:hover {
      border-color: #0066cc;
    }
    
    .connection-type-select:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 3px rgba(0, 102, 204, 0.3);
    }
    
    #canvas-container { 
      height: calc(100% - 60px); 
      position: relative;
      overflow: hidden;
    }
    
    #svg-canvas {
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle, #ddd 1px, transparent 1px);
      background-size: 20px 20px;
      cursor: grab;
    }
    
    #svg-canvas:active {
      cursor: grabbing;
    }
    
    .block {
      fill: #e6f3ff;
      stroke: #0066cc;
      stroke-width: 2;
      cursor: move;
    }
    
    .block:hover {
      fill: #cce6ff;
    }
    
    .block.selected {
      stroke: #ff6600;
      stroke-width: 3;
    }
    
    .block.has-child {
      stroke-dasharray: 5,5;
      stroke-width: 3;
    }
    
    .block.has-child::after {
      content: "üìÅ";
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
    }
    
    .block-text {
      fill: #333;
      font-family: system-ui, sans-serif;
      font-size: 12px;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
    }
    
    .connection {
      stroke: #666;
      stroke-width: 2;
      fill: none;
      marker-end: url(#arrowhead);
    }
    
    .port {
      fill: #fff;
      stroke: #333;
      stroke-width: 1;
      cursor: crosshair;
    }
    
    .port:hover {
      fill: #ffff99;
    }
    
    .status-legend {
      position: absolute;
      top: 60px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    /* Tooltip Styles */
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-family: system-ui, sans-serif;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      max-width: 300px;
      word-wrap: break-word;
    }
    
    .tooltip::before {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
    }
    
    .status-legend h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #333;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      margin: 3px 0;
    }
    
    .status-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 6px;
    }
    
    .connection-legend {
      position: absolute;
      top: 200px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 12px;
      font-size: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      max-width: 150px;
    }
    
    .connection-legend h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #333;
    }
    
    .connection-item {
      display: flex;
      align-items: center;
      margin: 3px 0;
      gap: 6px;
    }
    
    .connection-item svg {
      flex-shrink: 0;
    }
    
    .connection-item span {
      font-size: 11px;
      color: #333;
    }
    
    .rule-panel {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 100;
      max-width: 350px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .rule-panel h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #333;
    }
    
    .rule-result {
      display: flex;
      align-items: flex-start;
      margin: 3px 0;
      padding: 2px;
      border-radius: 2px;
    }
    
    .rule-result.error {
      background: #ffeeee;
      border-left: 3px solid #ff6666;
    }
    
    .rule-result.warning {
      background: #fff8e1;
      border-left: 3px solid #ffa726;
    }
    
    .rule-result.info {
      background: #e8f5e8;
      border-left: 3px solid #66bb6a;
    }
    
    .rule-icon {
      margin-right: 4px;
      font-weight: bold;
    }
    
    .rule-message {
      flex: 1;
      font-size: 10px;
      line-height: 1.3;
    }
    
    /* Search and Filter Styles */
    .search-container {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 0 5px;
    }
    
    .search-input {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 12px;
      width: 120px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 3px rgba(0,102,204,0.3);
    }
    
    .filter-btn {
      padding: 4px 8px;
      border: 1px solid #ccc;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .filter-btn.active {
      background: #0066cc;
      color: white;
      border-color: #0066cc;
    }
    
    .filter-btn:hover {
      background: #f0f0f0;
    }
    
    .filter-btn.active:hover {
      background: #0052a3;
    }
    
    .search-results-info {
      font-size: 11px;
      color: #666;
      margin-left: 5px;
    }
    
    /* Block highlighting for search */
    .block-group.search-highlight .block {
      stroke: #ff6600 !important;
      stroke-width: 3px !important;
      filter: drop-shadow(0 0 5px rgba(255,102,0,0.5));
    }
    
    .block-group.search-dimmed {
      opacity: 0.3;
    }
  </style>
</head>
<body>
  <header>
    <strong>System Blocks Diagram</strong>
    <div class="toolbar">
      <button id="btn-new">New</button>
      <button id="btn-save">Save</button>
      <button id="btn-load">Load</button>
      <div class="separator"></div>
      <!-- Undo/Redo -->
      <button id="btn-undo" class="context-btn" disabled title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
      <button id="btn-redo" class="context-btn" disabled title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
      <div class="separator"></div>
      <!-- Hierarchy Navigation -->
      <button id="btn-go-up" class="context-btn" disabled title="Go to Parent Diagram">‚Üë Up</button>
      <span id="breadcrumb-path" style="margin: 0 10px; font-size: 12px; color: #666;">Root</span>
      <button id="btn-drill-down" class="context-btn" disabled title="Open Child Diagram">‚Üì Drill Down</button>
      <button id="btn-create-child" class="context-btn" disabled title="Create Child Diagram">+ Child</button>
      <div class="separator"></div>
      <!-- Search and Filter -->
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search blocks..." title="Search by name, type, or status (Ctrl+F)">
        <button id="filter-all" class="filter-btn active" title="Show all blocks">All</button>
        <button id="filter-placeholder" class="filter-btn" title="Show only Placeholder blocks">Placeholder</button>
        <button id="filter-implemented" class="filter-btn" title="Show only Implemented blocks">Implemented</button>
        <span id="search-results" class="search-results-info"></span>
      </div>
      <div class="separator"></div>
      <!-- Connection Type Selector -->
      <div class="connection-type-container">
        <label for="connection-type-select" style="font-size: 12px; color: #666; margin-right: 5px;">Connection:</label>
        <select id="connection-type-select" class="connection-type-select" title="Choose connection type for new connections">
          <option value="auto" selected>Auto</option>
          <option value="electrical">‚ö° Electrical</option>
          <option value="power">üîå Power</option>
          <option value="data">üìä Data</option>
          <option value="mechanical">‚öôÔ∏è Mechanical</option>
        </select>
      </div>
      <div class="separator"></div>
      <button id="btn-add-block">Add Block</button>
      <button id="btn-snap-grid" class="toggle-btn active">Snap to Grid</button>
      <button id="btn-check-rules">Check Rules</button>
      <button id="btn-export-report">Export Report</button>
      <button id="btn-import">Import</button>
      <div class="separator"></div>
      <button id="btn-link-cad" class="context-btn" disabled>Link to CAD</button>
      <button id="btn-link-ecad" class="context-btn" disabled>Link to ECAD</button>
    </div>
  </header>
  
  <div id="canvas-container">
    <svg id="svg-canvas" viewBox="0 0 1000 1000">
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
        </marker>
      </defs>
      <g id="connections-layer"></g>
      <g id="blocks-layer"></g>
    </svg>
    
    <!-- Status Legend -->
    <div class="status-legend">
      <h4>Block Status</h4>
      <div class="status-item">
        <div class="status-color" style="background-color: #cccccc;"></div>
        <span>Placeholder</span>
      </div>
      <div class="status-item">
        <div class="status-color" style="background-color: #87ceeb;"></div>
        <span>Planned</span>
      </div>
      <div class="status-item">
        <div class="status-color" style="background-color: #ffd700;"></div>
        <span>In-Work</span>
      </div>
      <div class="status-item">
        <div class="status-color" style="background-color: #90ee90;"></div>
        <span>Implemented</span>
      </div>
      <div class="status-item">
        <div class="status-color" style="background-color: #00ff00;"></div>
        <span>Verified</span>
      </div>
    </div>
    
    <!-- Connection Type Legend -->
    <div class="connection-legend">
      <h4>Connection Types</h4>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" stroke="#dc3545" stroke-width="3"/>
          <polygon points="30,6 26,3 26,9" fill="#dc3545"/>
        </svg>
        <span>üîå Power</span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" stroke="#007bff" stroke-width="2"/>
          <polygon points="30,6 26,3 26,9" fill="#007bff"/>
        </svg>
        <span>üìä Data</span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" stroke="#28a745" stroke-width="1.5" stroke-dasharray="5,3"/>
          <polygon points="30,6 26,3 26,9" fill="#28a745"/>
        </svg>
        <span>‚ö° Electrical</span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" stroke="#6c757d" stroke-width="2" stroke-dasharray="8,4"/>
          <line x1="30" y1="3" x2="26" y2="6" stroke="#6c757d" stroke-width="2"/>
          <line x1="30" y1="9" x2="26" y2="6" stroke="#6c757d" stroke-width="2"/>
        </svg>
        <span>‚öôÔ∏è Mechanical</span>
      </div>
    </div>
    
    <!-- Rule Results Panel -->
    <div class="rule-panel" id="rule-panel">
      <h4>Rule Checks</h4>
      <div id="rule-results">
        <div class="rule-result info">
          <span class="rule-icon">‚ÑπÔ∏è</span>
          <span class="rule-message">Run checks to see results</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Import Dialog -->
  <div id="import-dialog" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                  background: white; border: 2px solid #ccc; padding: 20px; z-index: 1000; min-width: 500px;">
    <h3>Import Diagram</h3>
    
    <div style="margin-bottom: 15px;">
      <label>
        <input type="radio" name="import-type" value="mermaid" checked> 
        Import from Mermaid Flowchart
      </label>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>
        <input type="radio" name="import-type" value="csv"> 
        Import from CSV
      </label>
    </div>
    
    <!-- Mermaid Import -->
    <div id="mermaid-import" style="margin-bottom: 15px;">
      <label for="mermaid-text">Mermaid Flowchart Text:</label><br>
      <textarea id="mermaid-text" rows="8" cols="60" placeholder="flowchart TD&#10;    A[Start] --> B{Decision}&#10;    B -->|Yes| C[Process]&#10;    B -->|No| D[End]&#10;    C --> D"></textarea>
    </div>
    
    <!-- CSV Import -->
    <div id="csv-import" style="display: none; margin-bottom: 15px;">
      <label for="csv-blocks">Blocks CSV (name,type,x,y,status):</label><br>
      <textarea id="csv-blocks" rows="4" cols="60" placeholder="name,type,x,y,status&#10;Power Supply,PowerSupply,100,100,Verified&#10;Microcontroller,Microcontroller,300,100,Planned"></textarea>
      
      <br><br>
      <label for="csv-connections">Connections CSV (from,to,kind,protocol):</label><br>
      <textarea id="csv-connections" rows="4" cols="60" placeholder="from,to,kind,protocol&#10;Power Supply,Microcontroller,electrical,3.3V"></textarea>
    </div>
    
    <div style="text-align: right;">
      <button id="btn-import-cancel" style="margin-right: 10px;">Cancel</button>
      <button id="btn-import-ok">Import</button>
    </div>
  </div>
  
  <!-- Dialog Overlay -->
  <div id="dialog-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                   background: rgba(0,0,0,0.5); z-index: 999;"></div>
  
  <script>
    // Visual debug function
    function debugLog(message) {
      // Debug logging disabled for clean interface
      // console.log(message);
    }
  </script>
  <script src="./palette.js"></script>
</body>
</html>
