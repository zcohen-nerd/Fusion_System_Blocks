<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>System Blocks</title>
  <link rel="stylesheet" href="fusion-theme.css?v=milestone10-final4">
  <link rel="stylesheet" href="fusion-ribbon.css?v=ribbon">
  <link rel="stylesheet" href="fusion-icons.css?v=milestone10-final4">
  <style>
    /* === FORCED CSS OVERRIDES === */
    :root {
      --fusion-text-primary: #f0f0f0 !important;
      --fusion-text-secondary: #d0d0d0 !important;
      --fusion-transition-fast: 0.1s !important;
      --fusion-transition: 0.2s !important;
    }
    
    .block.selected {
      animation: blockSelect 0.15s ease-out !important;
    }
    
    .block.selected:hover {
      transform: translateY(-3px) scale(1.03) !important;
    }
    
    .block-type-menu {
      z-index: 99999 !important;
    }
    
    /* === FUSION 360 BASE STYLES === */
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: var(--fusion-font-family);
      background: var(--fusion-bg-primary);
      color: var(--fusion-text-primary);
      overflow: hidden;
    }
    
    /* === MILESTONE 10: ENHANCED HEADER STYLING === */
    header { 
      background: var(--fusion-gradient-secondary);
      border-bottom: 1px solid var(--fusion-border-primary);
      padding: 0;
      display: flex;
      flex-direction: column;
      box-shadow: var(--fusion-shadow-panel);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: visible;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      pointer-events: none;
    }
    
    .header-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      font-weight: 600;
      font-size: 13px;
      color: var(--fusion-text-primary);
      white-space: nowrap;
    }
    
    .header-logo img {
      width: 22px;
      height: 22px;
      object-fit: contain;
      border-radius: var(--fusion-radius-small);
    }
    
    /* === MILESTONE 10: ENHANCED TOOLBAR STYLING === */
    .toolbar {
      display: flex;
      gap: var(--fusion-spacing-sm);
      align-items: center;
      padding: var(--fusion-spacing-xs);
      background: var(--fusion-gradient-primary);
      border-radius: var(--fusion-radius-medium);
      box-shadow: var(--fusion-shadow-light);
      backdrop-filter: blur(5px);
      position: relative;
      z-index: 100000 !important;
    }
    
    .toolbar button {
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-md);
      border: 1px solid var(--fusion-button-border);
      background: var(--fusion-gradient-button);
      color: var(--fusion-text-primary);
      border-radius: var(--fusion-radius-medium);
      cursor: pointer;
      font-size: var(--fusion-font-size-normal);
      font-family: var(--fusion-font-family);
      font-weight: var(--fusion-font-weight-medium);
      transition: all var(--fusion-transition) var(--fusion-ease-in-out);
      outline: none;
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-xs);
      box-shadow: var(--fusion-shadow-button);
      position: relative;
      overflow: hidden;
    }
    
    .toolbar button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left var(--fusion-transition-slow) var(--fusion-ease-out);
    }
    
    .toolbar button:hover {
      background: var(--fusion-gradient-button-hover);
      border-color: var(--fusion-border-hover);
      transform: translateY(-1px);
      box-shadow: var(--fusion-shadow-button), 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    
    .toolbar button:hover::before {
      left: 100%;
    }
    
    .toolbar button:active {
      transform: translateY(0);
      background: var(--fusion-gradient-active);
      color: var(--fusion-text-inverse);
    }
    
    .toolbar-separator {
      width: 1px;
      height: 20px;
      background: var(--fusion-border-primary);
      margin: 0 var(--fusion-spacing-xs);
      opacity: 0.5;
    }
    
    .toolbar button.toggle-btn.active {
      background: var(--fusion-accent-blue);
      color: var(--fusion-text-inverse);
      border-color: var(--fusion-accent-blue);
    }
    
    .toolbar button.toggle-btn:hover {
      background: var(--fusion-accent-blue-dark);
      border-color: var(--fusion-accent-blue-dark);
    }
    
    .toolbar .separator {
      width: 1px;
      height: 20px;
      background: var(--fusion-border-primary);
      margin: 0 var(--fusion-spacing-xs);
    }
    
    .toolbar button.context-btn:disabled {
      background: var(--fusion-bg-secondary);
      color: var(--fusion-text-disabled);
      cursor: not-allowed;
      border-color: var(--fusion-border-primary);
    }
    
    .toolbar button.context-btn:not(:disabled):hover {
      background: var(--fusion-button-hover);
      border-color: var(--fusion-accent-blue);
    }
    
    /* === MILESTONE 14: ADVANCED DIAGRAM FEATURES TOOLBAR STYLING === */
    .toolbar-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--fusion-spacing-xs);
      padding: var(--fusion-spacing-xs);
      border-radius: var(--fusion-radius-small);
      background: var(--fusion-gradient-subtle);
      border: 1px solid var(--fusion-border-light);
      position: relative;
    }
    
    .toolbar-group .group-label {
      font-size: var(--fusion-font-size-small);
      color: var(--fusion-text-secondary);
      font-weight: var(--fusion-font-weight-medium);
      margin-bottom: var(--fusion-spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .toolbar-group .fusion-button {
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      min-width: 60px;
      font-size: var(--fusion-font-size-small);
      text-align: center;
    }
    
    .toolbar-group .fusion-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--fusion-bg-disabled);
      color: var(--fusion-text-disabled);
    }
    
    .toolbar-group .fusion-button:not(:disabled):hover {
      background: var(--fusion-button-hover);
      transform: translateY(-1px);
      box-shadow: var(--fusion-shadow-button);
    }
    
    .toolbar-group .fusion-icon {
      margin-right: var(--fusion-spacing-xs);
      font-size: var(--fusion-font-size-normal);
    }
    
    /* === MILESTONE 14: ADVANCED SELECTION AND ANNOTATION STYLING === */
    .block-selected {
      stroke: var(--fusion-accent-orange) !important;
      stroke-width: 3px !important;
      filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.6));
    }

    /* Multi-selection highlight applied by advancedFeatures.addToSelection */
    g.block.highlighted > g > rect,
    g.block.highlighted > g > ellipse,
    g.block.highlighted > g > polygon {
      stroke: #FF6B35 !important;
      stroke-width: 3 !important;
    }
    
    .selection-box {
      fill: rgba(0, 120, 212, 0.1);
      stroke: var(--fusion-accent-blue);
      stroke-width: 1;
      stroke-dasharray: 4,4;
      pointer-events: none;
    }
    
    .group-indicator {
      fill: none;
      stroke: var(--fusion-accent-yellow);
      stroke-width: 2;
      stroke-dasharray: 6,4;
      opacity: 0.8;
      pointer-events: none;
    }
    
    .annotation-text {
      font-family: var(--fusion-font-family);
      fill: var(--fusion-text-primary);
      user-select: none;
      pointer-events: none;
    }
    
    .annotation-note {
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }
    
    .annotation-dimension {
      stroke: var(--fusion-accent-green);
      fill: var(--fusion-accent-green);
      font-size: 11px;
    }
    
    .annotation-callout {
      filter: drop-shadow(1px 1px 3px rgba(0,0,0,0.2));
    }
    
    .notification {
      animation: slideInFromRight 0.3s ease-out;
    }
    
    @keyframes slideInFromRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Responsive toolbar adjustments */
    @media (max-width: 768px) {
      .toolbar-group {
        flex-direction: row;
        gap: var(--fusion-spacing-xs);
      }
      
      .toolbar-group .fusion-button {
        min-width: 40px;
        padding: var(--fusion-spacing-xs);
      }
      
      .group-label {
        display: none;
      }
    }
    
    .connection-type-container {
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-xs);
    }
    
    .connection-type-select {
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      border: 1px solid var(--fusion-input-border);
      border-radius: var(--fusion-radius-small);
      font-size: var(--fusion-font-size-normal);
      font-family: var(--fusion-font-family);
      background: var(--fusion-input-bg);
      color: var(--fusion-text-primary);
      cursor: pointer;
      transition: var(--fusion-transition);
    }
    
    .connection-type-select:hover {
      border-color: var(--fusion-border-hover);
    }
    
    .connection-type-select:focus {
      outline: none;
      border-color: var(--fusion-input-focus);
      box-shadow: 0 0 0 1px var(--fusion-input-focus);
    }
    
    #canvas-container { 
      height: calc(100% - 94px); 
      position: relative;
      overflow: hidden;
      background: var(--fusion-bg-primary);
      z-index: 1 !important;
    }
    
    #svg-canvas {
      width: 100%;
      height: 100%;
      background: var(--fusion-bg-primary);
      background-image: radial-gradient(circle, var(--fusion-border-primary) 1px, transparent 1px);
      background-size: 20px 20px;
      cursor: grab;
      transition: var(--fusion-transition);
    }
    
    #svg-canvas:active {
      cursor: grabbing;
    }
    
    /* ========== CONTEXT MENU ========== */

    /* Connection port dots — visible on block hover */
    .block:hover .connection-port { opacity: 1 !important; transition: opacity 0.15s; }
    .connection-port:hover { fill: var(--fusion-accent-blue, #2196F3) !important; r: 7; cursor: crosshair; }

    .fusion-context-menu {
      display: none;
      background: var(--fusion-panel-bg, #2b2b2b);
      border: 1px solid var(--fusion-panel-border, #555);
      border-radius: 6px;
      padding: 4px 0;
      min-width: 200px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      font-size: 13px;
      color: var(--fusion-text-primary, #eee);
      user-select: none;
    }
    .fusion-context-menu.show { display: block; }
    .fusion-context-menu-item {
      padding: 6px 12px 6px 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      white-space: nowrap;
    }
    .fusion-context-menu-item:hover {
      background: var(--fusion-bg-hover, #3a3a3a);
    }
    .fusion-context-menu-item.danger { color: #f44336; }
    .fusion-context-menu-item .ctx-icon { position: absolute; left: 8px; font-size: 14px; }
    .fusion-context-menu-item .ctx-shortcut {
      margin-left: auto;
      opacity: 0.5;
      font-size: 11px;
    }
    .fusion-context-menu-item .ctx-arrow {
      margin-left: auto;
      opacity: 0.5;
    }
    .fusion-context-menu-separator {
      height: 1px;
      background: var(--fusion-panel-border, #444);
      margin: 4px 8px;
    }
    /* Submenus */
    .fusion-context-menu-item.has-submenu > .fusion-context-submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: -4px;
      background: var(--fusion-panel-bg, #2b2b2b);
      border: 1px solid var(--fusion-panel-border, #555);
      border-radius: 6px;
      padding: 4px 0;
      min-width: 140px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }
    .fusion-context-menu-item.has-submenu:hover > .fusion-context-submenu {
      display: block;
    }

    /* ========== FUSION 360 ENHANCED BLOCK STYLES - PHASE 2 ========== */
    
    /* Base Block Style - Professional Rounded Rectangle */
    .block {
      fill: var(--fusion-bg-tertiary);
      stroke: var(--fusion-border-primary);
      stroke-width: 1.5;
      cursor: move;
      rx: var(--fusion-radius-medium);
      ry: var(--fusion-radius-medium);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15)) drop-shadow(0 1px 2px rgba(0,0,0,0.25));
      /* NOTE: Do NOT use 'transition: all' or 'transform' here.
         SVG block positions are set via the transform attribute by JavaScript.
         CSS transform overrides SVG transform attributes, breaking positioning. */
      transition: fill var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1),
                  stroke var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1),
                  filter var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Enhanced Hover State - Elevated with Glow (no CSS transform — SVG manages position) */
    .block:hover {
      fill: var(--fusion-bg-hover);
      stroke: var(--fusion-accent-blue);
      stroke-width: 2;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2)) 
              drop-shadow(0 2px 4px rgba(0,0,0,0.3))
              drop-shadow(0 0 0 1px var(--fusion-accent-blue));
    }
    
    /* Professional Selected State - Orange Accent with Glow (no CSS transform) */
    .block.selected {
      stroke: var(--fusion-accent-orange);
      stroke-width: 2.5;
      fill: var(--fusion-bg-hover);
      filter: drop-shadow(0 4px 12px rgba(255,102,0,0.3)) 
              drop-shadow(0 2px 6px rgba(0,0,0,0.25))
              drop-shadow(0 0 0 2px rgba(255,102,0,0.2));
    }
    
    /* Child Block Indicator - Professional Dashed Pattern */
    .block.has-child {
      stroke: var(--fusion-accent-yellow);
      stroke-width: 2;
      stroke-dasharray: 8,4;
      fill: var(--fusion-bg-tertiary);
      filter: drop-shadow(0 2px 6px rgba(255,215,0,0.2)) 
              drop-shadow(0 1px 3px rgba(0,0,0,0.2));
    }
    
    /* Child Indicator Icon - Professional SVG Icon */
    .block.has-child::after {
      content: "";
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 14px;
      height: 14px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffc107'%3E%3Cpath d='M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z'/%3E%3C/svg%3E");
      background-size: contain;
      background-repeat: no-repeat;
      opacity: 0.9;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      transition: all var(--fusion-transition-fast);
    }
    
    .block.has-child:hover::after {
      opacity: 1;
      transform: scale(1.1);
    }
    
    /* Enhanced Typography - Professional Text Rendering */
    .block-text,
    .block > text,
    g.block > text {
      fill: #333333 !important;        /* dark text on light block backgrounds */
      stroke: none !important;         /* prevent inherited stroke from parent .block group */
      font-family: var(--fusion-font-family);
      font-weight: 500;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
    }
    
    /* Block Type Indicators - Status-Based Styling */
    .block[data-status="placeholder"] {
      fill: var(--fusion-status-placeholder-bg);
      stroke: var(--fusion-status-placeholder);
    }
    
    .block[data-status="planned"] {
      fill: var(--fusion-status-planned-bg);
      stroke: var(--fusion-status-planned);
    }
    
    .block[data-status="in-work"] {
      fill: var(--fusion-status-in-work-bg);
      stroke: var(--fusion-status-in-work);
    }
    
    .block[data-status="implemented"] {
      fill: var(--fusion-status-implemented-bg);
      stroke: var(--fusion-status-implemented);
    }
    
    .block[data-status="verified"] {
      fill: var(--fusion-status-verified-bg);
      stroke: var(--fusion-status-verified);
    }
    
    /* Connection Point Enhancements */
    .connection-point {
      fill: var(--fusion-accent-blue);
      stroke: var(--fusion-bg-primary);
      stroke-width: 2;
      r: 4;
      opacity: 0;
      transition: all var(--fusion-transition-fast);
      cursor: crosshair;
    }
    
    .block:hover .connection-point {
      opacity: 1;
      r: 5;
      filter: drop-shadow(0 2px 4px rgba(0,123,204,0.4));
    }
    
    .connection-point:hover {
      fill: var(--fusion-accent-orange);
      r: 6;
      filter: drop-shadow(0 2px 6px rgba(255,102,0,0.5));
    }
    
    /* Block Size Variants */
    .block.small {
      rx: var(--fusion-radius-small);
      ry: var(--fusion-radius-small);
    }
    
    .block.large {
      rx: var(--fusion-radius-large);
      ry: var(--fusion-radius-large);
    }
    
    /* Block Text Size Variants */
    .block-text.small {
      font-size: var(--fusion-font-size-small);
      font-weight: 400;
    }
    
    .block-text.large {
      font-size: var(--fusion-font-size-large);
      font-weight: 600;
    }
    
    /* Block Animation for Creation */
    .block.new {
      animation: blockAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    @keyframes blockAppear {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    /* ========== FUSION 360 ENHANCED CONNECTION STYLES - PHASE 2 ========== */
    
    /* Base Connection Line - Professional with Smooth Curves */
    .connection {
      stroke: var(--fusion-text-secondary);
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      marker-end: url(#arrowhead);
      transition: all var(--fusion-transition-fast) ease;
      opacity: 0.8;
    }
    
    /* Enhanced Connection Hover - Animated Glow */
    .connection:hover {
      stroke-width: 3;
      opacity: 1;
      filter: drop-shadow(0 0 4px currentColor) drop-shadow(0 0 8px rgba(0,123,204,0.3));
      stroke: var(--fusion-accent-blue);
    }
    
    /* Connection Type Styling - Professional Engineering Colors */
    .connection[data-type="power"] {
      stroke: var(--fusion-connection-power);
      stroke-width: 3;
    }
    
    .connection[data-type="data"] {
      stroke: var(--fusion-connection-data);
      stroke-width: 2;
    }
    
    .connection[data-type="electrical"] {
      stroke: var(--fusion-connection-electrical);
      stroke-width: 1.5;
      stroke-dasharray: 5,3;
    }
    
    .connection[data-type="mechanical"] {
      stroke: var(--fusion-connection-mechanical);
      stroke-width: 2;
      stroke-dasharray: 8,4;
    }
    
    /* Enhanced Port Styling - Modern Connection Points */
    .port {
      fill: var(--fusion-accent-blue);
      stroke: var(--fusion-bg-primary);
      stroke-width: 2;
      cursor: crosshair;
      r: 4;
      opacity: 1;
      transition: all var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
    }
    
    /* Professional Port Hover - Elevated with Glow */
    .port:hover {
      fill: var(--fusion-accent-orange);
      stroke: var(--fusion-accent-orange);
      stroke-width: 2.5;
      r: 5;
      filter: drop-shadow(0 2px 6px rgba(255,102,0,0.4)) 
              drop-shadow(0 0 0 2px rgba(255,102,0,0.2));
      transform: scale(1.2);
    }
    
    /* Port Active State - Connected */
    .port.connected {
      fill: var(--fusion-accent-green);
      stroke: var(--fusion-accent-green);
      stroke-width: 2;
    }
    
    /* Connection Preview - Dotted Line While Dragging */
    .connection.preview {
      stroke: var(--fusion-accent-orange);
      stroke-width: 2;
      stroke-dasharray: 4,4;
      opacity: 0.7;
      animation: dashMove 1s linear infinite;
    }
    
    @keyframes dashMove {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: 8; }
    }
    
    /* === FUSION 360 LEGEND STYLES === */
    .status-legend {
      position: absolute;
      top: 60px;
      right: var(--fusion-spacing-md);
      background: var(--fusion-panel-bg);
      border: 1px solid var(--fusion-panel-border);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-md);
      font-size: var(--fusion-font-size-small);
      box-shadow: var(--fusion-shadow-medium);
      z-index: 100;
      color: var(--fusion-text-primary);
    }
    
    /* ========== FUSION 360 ENHANCED TOOLTIP STYLES - PHASE 2 ========== */
    
    /* Professional Tooltip - Glass Effect with Enhanced Shadow */
    .tooltip {
      position: absolute;
      background: rgba(56, 56, 56, 0.95);
      backdrop-filter: blur(8px);
      color: var(--fusion-text-primary);
      border: 1px solid rgba(70, 70, 70, 0.8);
      padding: var(--fusion-spacing-sm) var(--fusion-spacing-md);
      border-radius: var(--fusion-radius-medium);
      font-size: var(--fusion-font-size-normal);
      font-family: var(--fusion-font-family);
      font-weight: 400;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4), 
                  0 4px 12px rgba(0,0,0,0.3),
                  0 0 0 1px rgba(255,255,255,0.1);
      max-width: 300px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateY(4px);
      transition: all var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tooltip Show Animation */
    .tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Enhanced Tooltip Arrow - Glass Effect */
    .tooltip::before {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -6px;
      border: 6px solid transparent;
      border-top-color: rgba(56, 56, 56, 0.95);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    
    /* Tooltip Variants */
    .tooltip.error {
      border-color: var(--fusion-status-error);
      background: rgba(244, 67, 54, 0.15);
      backdrop-filter: blur(8px);
    }
    
    .tooltip.warning {
      border-color: var(--fusion-status-warning);
      background: rgba(255, 152, 0, 0.15);
      backdrop-filter: blur(8px);
    }
    
    .tooltip.info {
      border-color: var(--fusion-accent-blue);
      background: rgba(0, 123, 204, 0.15);
      backdrop-filter: blur(8px);
    }

    /* ========== FUSION 360 ENHANCED INTERACTIVE ELEMENTS - PHASE 2 ========== */
    
    /* Enhanced Canvas with Grid Pattern */
    #canvas {
      background: 
        radial-gradient(circle at 20px 20px, rgba(150,150,150,0.15) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    /* Professional Selection Rectangle */
    .selection-rect {
      fill: rgba(0, 123, 204, 0.1);
      stroke: var(--fusion-accent-blue);
      stroke-width: 1;
      stroke-dasharray: 4,2;
      opacity: 0.8;
      animation: selectionPulse 2s ease-in-out infinite;
    }
    
    @keyframes selectionPulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.4; }
    }
    
    /* Enhanced Drag Ghost - Semi-transparent Block */
    .drag-ghost {
      opacity: 0.6;
      transform: scale(0.95);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
      transition: none;
    }
    
    /* Drop Zone Highlight */
    .drop-zone {
      fill: rgba(76, 175, 80, 0.2);
      stroke: var(--fusion-accent-green);
      stroke-width: 2;
      stroke-dasharray: 6,3;
      animation: dropZonePulse 1.5s ease-in-out infinite;
    }
    
    @keyframes dropZonePulse {
      0%, 100% { 
        stroke-opacity: 1;
        fill-opacity: 0.2;
      }
      50% { 
        stroke-opacity: 0.5;
        fill-opacity: 0.1;
      }
    }
    
    /* Enhanced Focus Styles for Accessibility */
    .block:focus,
    .port:focus,
    .connection:focus {
      outline: 2px solid var(--fusion-accent-blue);
      outline-offset: 2px;
    }
    
    /* Keyboard Navigation Hints */
    .keyboard-hint {
      position: absolute;
      bottom: var(--fusion-spacing-md);
      left: var(--fusion-spacing-md);
      background: rgba(56, 56, 56, 0.9);
      color: var(--fusion-text-secondary);
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      border-radius: var(--fusion-radius-small);
      font-size: var(--fusion-font-size-small);
      font-family: var(--fusion-font-family);
      opacity: 0;
      transition: opacity var(--fusion-transition-fast);
    }
    
    .keyboard-hint.show {
      opacity: 1;
    }
    
    /* Block Label Enhancement */
    .block-label {
      font-weight: 500;
      letter-spacing: 0.02em;
      text-rendering: optimizeLegibility;
    }
    
    .block-sublabel {
      font-size: var(--fusion-font-size-small);
      font-weight: 400;
      opacity: 0.8;
    }

    /* ========== FUSION 360 PROFESSIONAL ICONOGRAPHY - PHASE 3 ========== */
    
    /* Connection Icon Styling */
    .connection-icon {
      margin-right: var(--fusion-spacing-xs);
      vertical-align: middle;
      opacity: 0.8;
      transition: all var(--fusion-transition-fast);
    }
    
    .connection-item:hover .connection-icon {
      opacity: 1;
      transform: scale(1.1);
    }
    
    /* Toolbar Button Icons */
    .toolbar button svg {
      margin-right: var(--fusion-spacing-xs);
      vertical-align: middle;
      opacity: 0.8;
      transition: all var(--fusion-transition-fast);
    }
    
    .toolbar button:hover svg {
      opacity: 1;
      transform: translateY(-1px);
    }
    
    .toolbar button:disabled svg {
      opacity: 0.4;
    }
    
    /* Icon Color Inheritance */
    .connection-icon,
    .toolbar button svg {
      color: currentColor;
    }
    
    /* ========== ADVANCED ANIMATIONS & MICRO-INTERACTIONS - PHASE 3 ========== */
    
    /* Pulsing Connection Points */
    .connection-point.active {
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { 
        opacity: 1;
        transform: scale(1);
      }
      50% { 
        opacity: 0.6;
        transform: scale(1.2);
      }
    }
    
    /* Floating Animation for New Blocks */
    .block.floating {
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }
    
    /* Connection Drawing Animation */
    .connection.drawing {
      stroke-dasharray: 300;
      stroke-dashoffset: 300;
      animation: drawConnection 0.8s ease-out forwards;
    }
    
    @keyframes drawConnection {
      to {
        stroke-dashoffset: 0;
      }
    }
    
    /* Block Selection Ripple Effect */
    .block.selecting::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(0, 123, 204, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: ripple 0.6s ease-out;
    }
    
    @keyframes ripple {
      to {
        width: 120%;
        height: 120%;
        opacity: 0;
      }
    }
    
    /* Enhanced Hover Effects */
    .block-group:hover .block {
      animation: subtleGlow 2s ease-in-out infinite;
    }
    
    @keyframes subtleGlow {
      0%, 100% { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15)) drop-shadow(0 1px 2px rgba(0,0,0,0.25)); }
      50% { filter: drop-shadow(0 4px 8px rgba(0,123,204,0.1)) drop-shadow(0 2px 4px rgba(0,0,0,0.25)); }
    }
    
    /* Toolbar Animation */
    .toolbar {
      animation: slideInFromTop 0.4s ease-out;
    }
    
    @keyframes slideInFromTop {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    /* Legend Panel Slide-in */
    .status-legend,
    .connection-legend,
    .history-panel {
      animation: slideInFromRight 0.4s ease-out;
    }

    /* === UNDO HISTORY PANEL === */
    .history-panel {
      position: fixed;
      right: 8px;
      top: 120px;
      width: 240px;
      max-height: 400px;
      background: var(--fusion-panel-bg, #2b2b2b);
      border: 1px solid var(--fusion-panel-border, #555);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      z-index: 5000;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .history-panel.show { display: flex; }
    .history-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--fusion-panel-border, #444);
      font-size: 13px;
      font-weight: 600;
      color: var(--fusion-text-primary, #eee);
    }
    .history-panel-header .history-close {
      background: none;
      border: none;
      color: var(--fusion-text-secondary, #aaa);
      cursor: pointer;
      font-size: 16px;
      padding: 0 4px;
    }
    .history-panel-header .history-close:hover { color: #fff; }
    .history-panel-header .history-count {
      font-size: 11px;
      color: var(--fusion-text-secondary, #999);
      font-weight: 400;
    }
    .history-panel-list {
      overflow-y: auto;
      flex: 1;
      padding: 4px 0;
      max-height: 340px;
    }
    .history-entry {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 12px;
      cursor: pointer;
      font-size: 12px;
      color: var(--fusion-text-primary, #ddd);
      transition: background 0.15s;
      position: relative;
    }
    .history-entry:hover { background: var(--fusion-bg-hover, #3a3a3a); }
    .history-entry.current {
      background: rgba(33, 150, 243, 0.15);
      border-left: 3px solid var(--fusion-accent-blue, #2196F3);
      font-weight: 600;
    }
    .history-entry.redo-entry { opacity: 0.45; }
    .history-entry .history-icon {
      font-size: 12px;
      flex-shrink: 0;
      width: 16px;
      text-align: center;
    }
    .history-entry .history-label { flex: 1; }
    .history-entry .history-time {
      font-size: 10px;
      color: var(--fusion-text-secondary, #888);
      flex-shrink: 0;
    }
    
    @keyframes slideInFromRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .status-legend h4 {
      margin: 0 0 var(--fusion-spacing-xs) 0;
      font-size: var(--fusion-font-size-normal);
      color: var(--fusion-text-primary);
      font-weight: 600;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      margin: var(--fusion-spacing-xs) 0;
    }
    
    .status-color {
      width: 12px;
      height: 12px;
      border-radius: var(--fusion-radius-small);
      margin-right: var(--fusion-spacing-xs);
      border: 1px solid var(--fusion-border-secondary);
    }
    
    /* === FUSION 360 CONNECTION LEGEND === */
    .connection-legend {
      position: absolute;
      top: 200px;
      right: var(--fusion-spacing-md);
      background: var(--fusion-panel-bg);
      border: 1px solid var(--fusion-panel-border);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-md);
      font-size: var(--fusion-font-size-normal);
      box-shadow: var(--fusion-shadow-medium);
      max-width: 150px;
      max-height: 400px;
      overflow-y: auto;
      color: var(--fusion-text-primary);
    }
    
    .connection-legend h4 {
      margin: 0 0 var(--fusion-spacing-xs) 0;
      font-size: var(--fusion-font-size-normal);
      color: var(--fusion-text-primary);
      font-weight: 600;
    }
    
    .connection-item {
      display: flex;
      align-items: center;
      margin: var(--fusion-spacing-xs) 0;
      gap: var(--fusion-spacing-xs);
    }
    
    .connection-item svg {
      flex-shrink: 0;
    }
    
    .connection-item span {
      font-size: var(--fusion-font-size-small);
      color: var(--fusion-text-primary);
    }
    
    /* === FUSION 360 RULE PANEL === */
    .rule-panel {
      position: absolute;
      bottom: var(--fusion-spacing-md);
      right: var(--fusion-spacing-md);
      background: var(--fusion-panel-bg);
      border: 1px solid var(--fusion-panel-border);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-md);
      font-size: var(--fusion-font-size-small);
      box-shadow: var(--fusion-shadow-medium);
      z-index: 100;
      max-width: 350px;
      max-height: 200px;
      overflow-y: auto;
      color: var(--fusion-text-primary);
    }
    
    .rule-panel h4 {
      margin: 0 0 var(--fusion-spacing-xs) 0;
      font-size: var(--fusion-font-size-normal);
      color: var(--fusion-text-primary);
      font-weight: 600;
    }
    
    .rule-result {
      display: flex;
      align-items: flex-start;
      margin: var(--fusion-spacing-xs) 0;
      padding: var(--fusion-spacing-xs);
      border-radius: var(--fusion-radius-small);
    }
    
    .rule-result.error {
      background: var(--fusion-status-error-bg);
      border-left: 3px solid var(--fusion-status-error);
    }
    
    .rule-result.warning {
      background: var(--fusion-status-warning-bg);
      border-left: 3px solid var(--fusion-status-warning);
    }
    
    .rule-result.info {
      background: var(--fusion-status-success-bg);
      border-left: 3px solid var(--fusion-status-success);
    }
    
    .rule-result.success {
      background: var(--fusion-status-success-bg);
      border-left: 3px solid var(--fusion-status-success);
    }
    
    .rule-result[style*="cursor: pointer"]:hover,
    .rule-result[style*="cursor:pointer"]:hover {
      filter: brightness(1.2);
    }
    
    .rule-icon {
      margin-right: var(--fusion-spacing-xs);
      font-weight: bold;
      color: var(--fusion-text-primary);
    }
    
    .rule-message {
      flex: 1;
      font-size: var(--fusion-font-size-small);
      line-height: 1.3;
      color: var(--fusion-text-primary);
    }
    
    /* === MODAL DIALOG STYLES === */
    .fusion-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 200000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fusion-modal {
      background: var(--fusion-panel-bg);
      border: 1px solid var(--fusion-panel-border);
      border-radius: var(--fusion-radius-large, 8px);
      padding: 20px;
      min-width: 300px;
      max-width: 420px;
      box-shadow: var(--fusion-shadow-large, 0 8px 24px rgba(0,0,0,0.4));
      color: var(--fusion-text-primary);
    }
    .fusion-modal h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
    }
    .fusion-modal kbd {
      display: inline-block;
      padding: 1px 6px;
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 11px;
      background: var(--fusion-bg-dark, #1a1a1a);
      border: 1px solid var(--fusion-panel-border, #444);
      border-radius: 3px;
      white-space: nowrap;
    }
    .doc-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: var(--fusion-radius-small);
      cursor: pointer;
      transition: background 0.15s;
    }
    .doc-list-item:hover {
      background: var(--fusion-hover-bg, rgba(255,255,255,0.08));
    }
    .doc-list-item .doc-name {
      font-weight: 600;
    }
    .doc-list-item .doc-date {
      font-size: 11px;
      color: var(--fusion-text-secondary);
    }
    .doc-list-item .doc-delete {
      color: var(--fusion-accent-red, #dc3545);
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      opacity: 0.6;
    }
    .doc-list-item .doc-delete:hover { opacity: 1; }

    /* === FUSION 360 SEARCH AND FILTER STYLES === */
    .search-container {
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-xs);
      margin: 0 var(--fusion-spacing-xs);
    }
    
    .search-input {
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      border: 1px solid var(--fusion-border-primary);
      border-radius: var(--fusion-radius-small);
      font-size: var(--fusion-font-size-normal);
      width: 120px;
      background: var(--fusion-input-bg);
      color: var(--fusion-text-primary);
      transition: var(--fusion-transition-fast);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--fusion-accent-blue);
      box-shadow: 0 0 3px var(--fusion-focus-ring);
    }
    
    .filter-btn {
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      border: 1px solid var(--fusion-border-primary);
      background: var(--fusion-button-bg);
      border-radius: var(--fusion-radius-small);
      cursor: pointer;
      font-size: var(--fusion-font-size-small);
      white-space: nowrap;
      color: var(--fusion-text-primary);
      transition: var(--fusion-transition-fast);
    }
    
    .filter-btn.active {
      background: var(--fusion-accent-blue);
      color: white;
      border-color: var(--fusion-accent-blue);
    }
    
    .filter-btn:hover {
      background: var(--fusion-button-hover);
    }
    
    .filter-btn.active:hover {
      background: var(--fusion-accent-blue-dark);
    }
    
    .search-results-info {
      font-size: var(--fusion-font-size-small);
      color: var(--fusion-text-secondary);
      margin-left: var(--fusion-spacing-xs);
    }
    
    /* === FUSION 360 SEARCH HIGHLIGHTING === */
    .block-group.search-highlight .block {
      stroke: var(--fusion-accent-orange) !important;
      stroke-width: 3px !important;
      filter: drop-shadow(0 0 5px var(--fusion-glow-orange));
    }
    
    .block-group.search-dimmed {
      opacity: 0.3;
    }

    /* === FUSION 360 STATUS COLOR CLASSES === */
    .status-placeholder { background-color: var(--fusion-status-placeholder); }
    .status-planned { background-color: var(--fusion-status-planned); }
    .status-in-work { background-color: var(--fusion-status-in-work); }
    .status-implemented { background-color: var(--fusion-status-implemented); }
    .status-verified { background-color: var(--fusion-status-verified); }

    /* === FUSION 360 UTILITY CLASSES === */
    .fusion-breadcrumb {
      margin: 0 var(--fusion-spacing-md);
      font-size: var(--fusion-font-size-normal);
      color: var(--fusion-text-secondary);
    }

    .fusion-label {
      font-size: var(--fusion-font-size-normal);
      color: var(--fusion-text-secondary);
      margin-right: var(--fusion-spacing-xs);
    }

    .fusion-legend-section {
      margin-top: var(--fusion-spacing-lg) !important;
    }

    /* === MILESTONE 10: ENHANCED SEARCH STYLING === */
    .search-container {
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-sm);
      flex-wrap: wrap;
    }
    
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .search-icon {
      position: absolute;
      left: var(--fusion-spacing-sm);
      color: var(--fusion-text-secondary);
      z-index: 1;
    }
    
    .search-input {
      padding-left: calc(var(--fusion-spacing-md) + 20px) !important;
      min-width: 200px;
    }
    
    .filter-buttons {
      display: flex;
      gap: var(--fusion-spacing-xs);
      align-items: center;
    }
    
    .filter-btn.active {
      background: var(--fusion-gradient-active) !important;
      color: var(--fusion-text-inverse) !important;
      box-shadow: var(--fusion-shadow-glow) !important;
    }
    
    .search-results-info {
      font-size: var(--fusion-font-size-small);
      color: var(--fusion-text-secondary);
      margin-left: var(--fusion-spacing-sm);
      font-style: italic;
    }

    /* === FUSION 360 CONNECTION LINE COLORS === */
    .connection-power { stroke: var(--fusion-connection-power); fill: var(--fusion-connection-power); }
    .connection-data { stroke: var(--fusion-connection-data); fill: var(--fusion-connection-data); }
    .connection-electrical { stroke: var(--fusion-connection-electrical); fill: var(--fusion-connection-electrical); }
    .connection-mechanical { stroke: var(--fusion-connection-mechanical); fill: var(--fusion-connection-mechanical); }
    .connection-generic { stroke: var(--fusion-text-secondary); fill: var(--fusion-text-secondary); }
  </style>
    <!-- Tabs + Status Bar base styles -->
    <style>
      /* Tab bar shown below ribbon; panels hidden by default (shown via .show class) */
      .sb-panel { display: none; }
      .sb-status { position: fixed; bottom: 0; left: 0; right: 0; height: 34px; display: flex; align-items: center; gap: 12px; padding: 6px 12px; border-top: 1px solid var(--fusion-border-primary); background: var(--fusion-bg-secondary); z-index: var(--z-fixed, 500); }
      .sb-status .pill { border: 1px solid var(--fusion-border-primary); border-radius: 12px; padding: 4px 8px; font-size: 12px; }
      .sb-section { margin-bottom: 16px; }
      .sb-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .sb-list { list-style: none; padding: 0; margin: 0; }
      .sb-list li { padding: 6px 8px; border: 1px solid var(--fusion-border-primary); border-radius: 6px; margin-bottom: 6px; background: var(--fusion-bg-tertiary); }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    </style>
</head>
<body>
  <!-- ARIA live region for screen reader announcements -->
  <div id="aria-live-announcer" aria-live="polite" aria-atomic="true" class="sr-only"></div>
  <header>
    <div class="header-logo">
      <img src="../assets/logo_full.png" alt="Fusion System Blocks logo" />
      <span>System Blocks</span>
    </div>
    <!-- Fusion 360 Style Ribbon Interface -->
    <div class="fusion-ribbon" role="toolbar" aria-label="System Blocks Toolbar">
      <div class="ribbon-groups">
        
        <!-- FILE GROUP -->
        <div class="ribbon-group" role="group" aria-label="File operations">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-new" class="ribbon-button-large" title="New Diagram — Create a blank diagram (Ctrl+N)" aria-label="Create New Diagram">
                <div class="ribbon-icon" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-new"/></svg></div>
                <div class="ribbon-text">New</div>
                <div class="ribbon-shortcut" aria-hidden="true">Ctrl+N</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-save" class="ribbon-button-small" title="Save Diagram — Save to Fusion 360 document (Ctrl+S)" aria-label="Save Diagram">
                  <div class="ribbon-icon-small" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-save"/></svg></div>
                  <span>Save</span>
                </button>
                <button id="btn-save-as" class="ribbon-button-small" title="Save As… (Ctrl+Shift+S)" aria-label="Save As">
                  <div class="ribbon-icon-small" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-save"/></svg></div>
                  <span>Save As…</span>
                </button>
                <button id="btn-export-report" class="ribbon-button-small" title="Export Report — Generate HTML/JSON report of the diagram" aria-label="Export Report">
                  <div class="ribbon-icon-small" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-export"/></svg></div>
                  <span>Export</span>
                </button>
              </div>
              <div class="ribbon-buttons-column">
                <button id="btn-load" class="ribbon-button-small" title="Load Diagram (Ctrl+O)" aria-label="Load Diagram">
                  <div class="ribbon-icon-small" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-load"/></svg></div>
                  <span>Load</span>
                </button>
                <button id="btn-open-named" class="ribbon-button-small" title="Open Named Document (Ctrl+Shift+O)" aria-label="Open Named Document">
                  <div class="ribbon-icon-small" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-load"/></svg></div>
                  <span>Open…</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">File</div>
        </div>

        <!-- EDIT GROUP -->
        <div class="ribbon-group" role="group" aria-label="Edit operations">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-undo" class="ribbon-button-large" disabled title="Undo (Ctrl+Z)" aria-label="Undo">
                <div class="ribbon-icon" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-undo"/></svg></div>
                <div class="ribbon-text">Undo</div>
                <div class="ribbon-shortcut" aria-hidden="true">Ctrl+Z</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-redo" class="ribbon-button-small" disabled title="Redo (Ctrl+Y)">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-redo"/></svg></div>
                  <span>Redo</span>
                </button>
                <button id="btn-import" class="ribbon-button-small" title="Import — Import diagram from Mermaid or CSV">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-load"/></svg></div>
                  <span>Import</span>
                </button>
                <button id="btn-copy" class="ribbon-button-small" title="Copy — Copy selected blocks to clipboard (Ctrl+C)">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-copy"/></svg></div>
                  <span>Copy</span>
                </button>
                <button id="btn-paste" class="ribbon-button-small" title="Paste — Paste blocks from clipboard (Ctrl+V)">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-paste"/></svg></div>
                  <span>Paste</span>
                </button>
                <button id="btn-history" class="ribbon-button-small" title="Toggle Undo History Panel">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-undo"/></svg></div>
                  <span>History</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Edit</div>
        </div>

        <!-- CREATE GROUP -->
        <div class="ribbon-group" role="group" aria-label="Create elements">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-add-block-ribbon" class="ribbon-button-large" title="Add Block — Create a new system block (B)" aria-label="Add Block">
                <div class="ribbon-icon" aria-hidden="true"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-block"/></svg></div>
                <div class="ribbon-text">Block</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-connect" class="ribbon-button-small" title="Connect — Draw a connection between two blocks (C)">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-link"/></svg></div>
                  <span>Connect</span>
                </button>
                <button id="btn-add-text" class="ribbon-button-small" title="Add Text — Coming soon">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-text"/></svg></div>
                  <span>Text</span>
                </button>
                <button id="btn-add-note" class="ribbon-button-small" title="Add Note — Coming soon">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-note"/></svg></div>
                  <span>Note</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Create</div>
        </div>
        <!-- NAVIGATE GROUP -->
        <div class="ribbon-group" role="group" aria-label="Navigation">
          <div class="ribbon-content">
            <div class="ribbon-button-row">
              <button id="btn-go-up" class="ribbon-button-small" disabled title="Go to Parent Diagram">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-go-up"/></svg></div>
                <span>Up</span>
              </button>
              <button id="btn-drill-down" class="ribbon-button-small" disabled title="Open Child Diagram">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-drill-down"/></svg></div>
                <span>Drill Down</span>
              </button>
              <button id="btn-create-child" class="ribbon-button-small" disabled title="Create Child Diagram">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-child"/></svg></div>
                <span>Create Child</span>
              </button>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Navigate</div>
        </div>
      <!-- SELECT GROUP -->
        <div class="ribbon-group" role="group" aria-label="Selection">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-select-all" class="ribbon-button-large" title="Select all blocks (Ctrl+A)">
                <div class="ribbon-icon"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-select-all"/></svg></div>
                <div class="ribbon-text">Select</div>
                <div class="ribbon-shortcut">Ctrl+A</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-select-none" class="ribbon-button-small" title="Clear selection (Esc)">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-clear"/></svg></div>
                  <span>Clear</span>
                </button>
                <button id="btn-group-create" class="ribbon-button-small" disabled title="Create group from selected blocks">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-group"/></svg></div>
                  <span>Group</span>
                </button>
                <button id="btn-group-ungroup" class="ribbon-button-small" disabled title="Ungroup selected groups">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-ungroup"/></svg></div>
                  <span>Ungroup</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Select</div>
        </div>

        <!-- ARRANGE GROUP -->
        <div class="ribbon-group" role="group" aria-label="Arrange">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-auto-layout" class="ribbon-button-large" title="Auto Layout — Arrange all blocks with smart layout algorithm">
                <div class="ribbon-icon"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-auto-layout"/></svg></div>
                <div class="ribbon-text">Auto Layout</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-align-left" class="ribbon-button-small" disabled title="Align selected blocks to left edge">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-align-left"/></svg></div>
                  <span>Left</span>
                </button>
                <button id="btn-align-center" class="ribbon-button-small" disabled title="Align selected blocks to center">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-align-center"/></svg></div>
                  <span>Center</span>
                </button>
                <button id="btn-align-right" class="ribbon-button-small" disabled title="Align selected blocks to right edge">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-align-left"/></svg></div>
                  <span>Right</span>
                </button>
                <button id="btn-distribute-h" class="ribbon-button-small" disabled title="Distribute selected blocks horizontally">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-distribute"/></svg></div>
                  <span>Distribute</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Arrange</div>
        </div>

        <!-- ANNOTATE GROUP -->
        <div class="ribbon-group" role="group" aria-label="Annotate">
          <div class="ribbon-content">
            <div class="ribbon-button-row">
              <button id="btn-add-dimension" class="ribbon-button-small" title="Add Dimension — Coming soon">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-ruler"/></svg></div>
                <span>Dimension</span>
              </button>
              <button id="btn-add-callout" class="ribbon-button-small" title="Add Callout — Coming soon">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-comment"/></svg></div>
                <span>Callout</span>
              </button>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Annotate</div>
        </div>

        <!-- VIEW GROUP -->
        <div class="ribbon-group" role="group" aria-label="View">
          <div class="ribbon-content">
            <div class="ribbon-mixed">
              <button id="btn-fit-view" class="ribbon-button-large" title="Fit to View">
                <div class="ribbon-icon"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-zoom"/></svg></div>
                <div class="ribbon-text">Fit</div>
              </button>
              <div class="ribbon-buttons-column">
                <button id="btn-snap-grid" class="ribbon-button-small active" title="Snap to Grid">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-hash"/></svg></div>
                  <span>Grid</span>
                </button>
                <button id="btn-zoom-in" class="ribbon-button-small" title="Zoom In">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-zoom"/></svg></div>
                  <span>Zoom In</span>
                </button>
                <button id="btn-zoom-out" class="ribbon-button-small" title="Zoom Out">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-zoom"/></svg></div>
                  <span>Zoom Out</span>
                </button>
              </div>
              <div class="ribbon-buttons-column">
                <button id="btn-minimap" class="ribbon-button-small active" title="Toggle Minimap (M)" aria-label="Toggle Minimap">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-zoom"/></svg></div>
                  <span>Minimap</span>
                </button>
                <button id="btn-routing-mode" class="ribbon-button-small" title="Toggle orthogonal routing" aria-label="Toggle Orthogonal Routing">
                  <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-zoom"/></svg></div>
                  <span>Ortho</span>
                </button>
              </div>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">View</div>
        </div>

        <!-- VALIDATE GROUP -->
        <div class="ribbon-group" role="group" aria-label="Validate">
          <div class="ribbon-content">
            <button id="btn-check-rules" class="ribbon-button-large" title="Check Rules">
              <div class="ribbon-icon"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-check"/></svg></div>
              <div class="ribbon-text">Check Rules</div>
            </button>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Validate</div>
        </div>

        <!-- CAD GROUP -->
        <div class="ribbon-group" role="group" aria-label="CAD Links">
          <div class="ribbon-content">
            <div class="ribbon-button-row">
              <button id="btn-link-cad" class="ribbon-button-small" disabled title="Link to CAD">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-link"/></svg></div>
                <span>CAD</span>
              </button>
              <button id="btn-link-ecad" class="ribbon-button-small" disabled title="Link to ECAD">
                <div class="ribbon-icon-small"><svg viewBox="0 0 12 12" fill="currentColor"><use href="#icon-ecad"/></svg></div>
                <span>ECAD</span>
              </button>
            </div>
          </div>
          <div class="ribbon-group-label" aria-hidden="true">Links</div>
        </div>

      </div>
      
      <!-- Secondary Toolbar for Search and Connection Tools -->
      <div class="ribbon-secondary">
        <div class="search-container">
          <div class="search-input-wrapper">
            <svg class="fusion-icon search-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
            </svg>
            <input type="text" id="search-input" class="fusion-input search-input" placeholder="Search blocks..." title="Search by name, type, or status (Ctrl+F)">
          </div>
          <div class="filter-buttons">
            <button id="filter-all" class="fusion-button filter-btn active" title="Show all blocks">All</button>
            <button id="filter-placeholder" class="fusion-button filter-btn" title="Show only Placeholder blocks">Placeholder</button>
            <button id="filter-implemented" class="fusion-button filter-btn" title="Show only Implemented blocks">Implemented</button>
          </div>
        </div>
        
        <div class="connection-type-container">
          <label for="connection-type-select" class="fusion-label">Connection:</label>
          <select id="connection-type-select" class="connection-type-select" title="Choose connection type for new connections">
            <option value="electrical" selected>Electrical</option>
            <option value="power">Power</option>
            <option value="data">Data</option>
            <option value="mechanical">Mechanical</option>
          </select>
          <select id="arrow-direction-select" class="connection-type-select fusion-select" title="Choose arrow direction">
            <option value="forward" selected>Forward</option>
            <option value="bidirectional">Bidirectional</option>
            <option value="backward">Backward</option>
            <option value="none">None</option>
          </select>
        </div>
        
        <div class="breadcrumb-container">
          <span id="breadcrumb-path" class="fusion-breadcrumb">Root</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Task-first Tabs Bar (below ribbon) -->
  <nav class="sb-tabbar" role="tablist" aria-label="System Blocks Tabs">
    <button id="tab-home" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-home">Home</button>
    <button id="tab-diagram" class="sb-tab" role="tab" aria-selected="true" aria-controls="panel-diagram">Diagram</button>
    <button id="tab-linking" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-linking">Linking</button>
    <button id="tab-validation" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-validation">Validation</button>
    <button id="tab-requirements" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-requirements">Reqs</button>
    <button id="tab-history" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-history">History</button>
    <button id="tab-reports" class="sb-tab" role="tab" aria-selected="false" aria-controls="panel-reports">Reports</button>
    <span class="sr-only" id="tab-status" aria-live="polite"></span>
  </nav>

  <div id="canvas-container">
    <!-- Empty canvas state indicator -->
    <div id="empty-canvas-state" class="empty-canvas-state">
      <svg class="empty-canvas-icon" viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="8" y="8" width="32" height="32" rx="4"/>
        <path d="M18 24h12M24 18v12"/>
      </svg>
      <h3>No blocks yet</h3>
      <p>Click <strong>Block</strong> in the ribbon or use keyboard shortcut to add your first block</p>
      <button id="btn-add-first-block" class="fusion-button primary" aria-label="Add your first block">
        <svg viewBox="0 0 12 12" fill="currentColor" width="14" height="14"><use href="#icon-add"/></svg>
        Add Block
      </button>
    </div>
    <svg id="svg-canvas" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet"
         role="img" aria-label="System blocks diagram canvas" tabindex="0">
      <defs>
        <!-- === Connection Arrow Markers (typed + directional) === -->
        <!-- Fixed size markers (userSpaceOnUse) to prevent huge arrows on thick lines -->
        <!-- Generic (auto / default) — forward -->
        <marker id="arrowhead" markerWidth="10" markerHeight="7"
                refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
        </marker>
        <!-- Generic reverse (for bidirectional start) -->
        <marker id="arrowhead-reverse" markerWidth="10" markerHeight="7"
                refX="0" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="10 0, 0 3.5, 10 7" fill="#666" />
        </marker>

        <!-- Power — forward & reverse -->
        <marker id="arrowhead-power" markerWidth="10" markerHeight="7"
                refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="0 0, 10 3.5, 0 7" fill="#dc3545" />
        </marker>
        <marker id="arrowhead-power-reverse" markerWidth="10" markerHeight="7"
                refX="0" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="10 0, 0 3.5, 10 7" fill="#dc3545" />
        </marker>

        <!-- Data — forward & reverse -->
        <marker id="arrowhead-data" markerWidth="10" markerHeight="7"
                refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="0 0, 10 3.5, 0 7" fill="#007bff" />
        </marker>
        <marker id="arrowhead-data-reverse" markerWidth="10" markerHeight="7"
                refX="0" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="10 0, 0 3.5, 10 7" fill="#007bff" />
        </marker>

        <!-- Electrical — forward & reverse -->
        <marker id="arrowhead-electrical" markerWidth="10" markerHeight="7"
                refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="0 0, 10 3.5, 0 7" fill="#28a745" />
        </marker>
        <marker id="arrowhead-electrical-reverse" markerWidth="10" markerHeight="7"
                refX="0" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="10 0, 0 3.5, 10 7" fill="#28a745" />
        </marker>

        <!-- Mechanical — forward & reverse -->
        <marker id="arrowhead-mechanical" markerWidth="10" markerHeight="7"
                refX="10" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="0 0, 10 3.5, 0 7" fill="#6c757d" />
        </marker>
        <marker id="arrowhead-mechanical-reverse" markerWidth="10" markerHeight="7"
                refX="0" refY="3.5" orient="auto" markerUnits="userSpaceOnUse">
          <polygon points="10 0, 0 3.5, 10 7" fill="#6c757d" />
        </marker>

        <!-- ========== FUSION 360 PROFESSIONAL ICON DEFINITIONS - PHASE 3 ========== -->
        
        <!-- Power Connection Icon -->
        <g id="icon-power">
          <circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M6 2v4M4 4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <!-- Data Connection Icon -->
        <g id="icon-data">
          <rect x="2" y="4" width="8" height="4" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 6h4M4 7h2" stroke="currentColor" stroke-width="1" opacity="0.7"/>
        </g>
        
        <!-- Electrical Connection Icon -->
        <g id="icon-electrical">
          <path d="M2 6h3l-1 2h2l-3 3 1-2H2l2-3z" fill="currentColor"/>
        </g>
        
        <!-- Mechanical Connection Icon -->
        <g id="icon-mechanical">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="1.5" fill="currentColor"/>
          <path d="M6 2v2M10 6h-2M6 10V8M2 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <!-- Block Type Icons -->
        <g id="icon-block-system">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M5 5h2M5 7h2" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <g id="icon-block-component">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2" fill="currentColor" opacity="0.3"/>
        </g>
        
        <g id="icon-block-interface">
          <path d="M2 4h8v4H2z" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 2v2M8 2v2M4 8v2M8 8v2" stroke="currentColor" stroke-width="1.5"/>
        </g>
        
        <!-- Status Icons -->
        <g id="icon-status-verified">
          <circle cx="6" cy="6" r="5" fill="currentColor" opacity="0.2"/>
          <path d="M3.5 6l1.5 1.5L8.5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-status-error">
          <circle cx="6" cy="6" r="5" fill="currentColor" opacity="0.2"/>
          <path d="M4 4l4 4M8 4l-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </g>
        
        <g id="icon-status-warning">
          <path d="M6 2L10.5 9H1.5z" fill="currentColor" opacity="0.2"/>
          <path d="M6 4v3M6 8h0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <!-- Navigation Icons -->
        <g id="icon-drill-down">
          <path d="M6 2v8M3 7l3 3 3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-go-up">
          <path d="M6 10V2M3 5l3-3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <!-- Tool Icons -->
        <g id="icon-add">
          <circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M6 3v6M3 6h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-search">
          <circle cx="5" cy="5" r="3" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="m8 8 2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-filter">
          <path d="M2 3h8l-3 4v4l-2-1V7z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        </g>
        
        <!-- ========== MILESTONE 11: ELECTRICAL BLOCK ICONS - PHASE 1 ========== -->
        
        <!-- Microcontroller Icons -->
        <g id="icon-microcontroller">
          <rect x="2" y="3" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3.5" y="4.5" width="5" height="3" rx="0.5" fill="currentColor" opacity="0.3"/>
          <circle cx="4" cy="5" r="0.5" fill="currentColor"/>
          <circle cx="8" cy="7" r="0.5" fill="currentColor"/>
          <path d="M2 4h-1M2 6h-1M2 8h-1M10 4h1M10 6h1M10 8h1" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <g id="icon-microcontroller-wifi">
          <rect x="2" y="3" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3.5" y="4.5" width="5" height="3" rx="0.5" fill="currentColor" opacity="0.3"/>
          <path d="M5 6.5c.5-.3 1-.3 1.5 0M4.5 6c.8-.5 1.7-.5 2.5 0M5.5 7c.2-.1.3-.1.5 0" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
          <circle cx="6" cy="7.5" r="0.3" fill="currentColor"/>
        </g>
        
        <!-- Power Supply Icons -->
        <g id="icon-power-supply">
          <rect x="2" y="4" width="8" height="4" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 6h4M4 7h2" stroke="currentColor" stroke-width="1"/>
          <circle cx="3" cy="6" r="0.5" fill="currentColor"/>
          <circle cx="9" cy="6" r="0.5" fill="currentColor"/>
          <path d="M1 6h1M10 6h1" stroke="currentColor" stroke-width="1.5"/>
        </g>
        
        <g id="icon-power-switching">
          <rect x="2" y="4" width="8" height="4" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 5.5l1 1 1-1 1 1 1-1M4 6.5h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="3" cy="6" r="0.5" fill="currentColor"/>
          <circle cx="9" cy="6" r="0.5" fill="currentColor"/>
        </g>
        
        <!-- Sensor Icons -->
        <g id="icon-sensor-temp">
          <circle cx="6" cy="7" r="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="5.5" y="3" width="1" height="4" fill="currentColor"/>
          <circle cx="6" cy="7" r="1" fill="currentColor"/>
          <path d="M8 4h1M8 5h0.5M8 6h1" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <g id="icon-sensor-accel">
          <rect x="3" y="3" width="6" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4.5v3M4.5 6h3" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="6" cy="6" r="0.5" fill="currentColor"/>
        </g>
        
        <!-- Communication Module Icons -->
        <g id="icon-comm-wifi">
          <path d="M6 9c2.5-1.5 2.5-4.5 0-6M6 9c-2.5-1.5-2.5-4.5 0-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/>
          <path d="M6 8.5c1.5-1 1.5-3 0-4M6 8.5c-1.5-1-1.5-3 0-4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" fill="none"/>
          <path d="M6 8c0.8-0.5 0.8-1.5 0-2M6 8c-0.8-0.5-0.8-1.5 0-2" stroke="currentColor" stroke-width="1" stroke-linecap="round" fill="none"/>
          <circle cx="6" cy="8" r="0.5" fill="currentColor"/>
        </g>
        
        <g id="icon-comm-bluetooth">
          <path d="M6 2l2 2-1.5 1.5L8 7l-2 2v-3.5L4.5 7 6 5.5V2z" fill="currentColor"/>
          <path d="M4 4l4 4M4 8l4-4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <!-- Enhanced Block Component Icon -->
        <g id="icon-block-advanced">
          <rect x="2" y="2" width="8" height="8" rx="1.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="4" y="4" width="4" height="4" rx="0.5" fill="currentColor" opacity="0.2"/>
          <circle cx="5" cy="5" r="0.5" fill="currentColor"/>
          <circle cx="7" cy="5" r="0.5" fill="currentColor"/>
          <circle cx="5" cy="7" r="0.5" fill="currentColor"/>
          <circle cx="7" cy="7" r="0.5" fill="currentColor"/>
        </g>

        <!-- ========== MILESTONE 11 PHASE 2: MECHANICAL SYSTEM ICONS ========== -->
        
        <!-- Mechanical Category Icon -->
        <g id="icon-mechanical">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 2v2M6 8v2M2 6h2M8 6h2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <!-- Motor Icons -->
        <g id="icon-motor-servo">
          <rect x="2" y="4" width="8" height="4" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4.5v3M4.5 6h3" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M6 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </g>
        
        <g id="icon-motor-stepper">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4v4M4 6h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="3" cy="3" r="0.5" fill="currentColor"/>
          <circle cx="9" cy="3" r="0.5" fill="currentColor"/>
          <circle cx="3" cy="9" r="0.5" fill="currentColor"/>
          <circle cx="9" cy="9" r="0.5" fill="currentColor"/>
        </g>
        
        <g id="icon-actuator-linear">
          <rect x="2" y="5" width="8" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="8" y="4" width="2" height="4" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 4l2-1 2 1" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <!-- Sensor Icons -->
        <g id="icon-sensor-encoder">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 2v1M6 9v1M2 6h1M9 6h1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M8.5 3.5l-0.7 0.7M4.2 8.8l-0.7 0.7M3.5 3.5l0.7 0.7M8.8 8.8l0.7 0.7" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <g id="icon-sensor-load">
          <rect x="3" y="5" width="6" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M6 3v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M5 3h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M4 8v1M8 8v1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M3 9h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-sensor-proximity">
          <rect x="3" y="3" width="6" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4.5v3M4.5 6h3" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
          <path d="M6 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </g>
        
        <!-- Structural Element Icons -->
        <g id="icon-bearing">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="6" cy="6" r="1" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="6" cy="3" r="0.4" fill="currentColor"/>
          <circle cx="9" cy="6" r="0.4" fill="currentColor"/>
          <circle cx="6" cy="9" r="0.4" fill="currentColor"/>
          <circle cx="3" cy="6" r="0.4" fill="currentColor"/>
        </g>
        
        <g id="icon-coupling">
          <rect x="2" y="5" width="3" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="7" y="5" width="3" height="2" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M5.5 5.5l1 1M5.5 6.5l1-1" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <g id="icon-gearbox">
          <rect x="2" y="3" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="5" cy="6" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="7.5" cy="6" r="1" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6.5 6h1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M2 5h1M9 5h1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>

        <!-- ========== MILESTONE 11 PHASE 3: SOFTWARE/FIRMWARE ICONS ========== -->
        
        <!-- Software Category Icon -->
        <g id="icon-software">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 4l2 2-2 2M6 8h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <!-- Control Algorithm Icons -->
        <g id="icon-software-pid">
          <rect x="2" y="3" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 6h6" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M4 5v2M6 4v4M8 5v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
          <circle cx="4" cy="5" r="0.3" fill="currentColor"/>
          <circle cx="6" cy="4" r="0.3" fill="currentColor"/>
          <circle cx="8" cy="5" r="0.3" fill="currentColor"/>
        </g>
        
        <g id="icon-software-fsm">
          <circle cx="4" cy="4" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="4" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="6" cy="8" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5.5 4h1M7 5l-0.5 2M5 5l0.5 2" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" marker-end="url(#arrowhead-small)"/>
        </g>
        
        <g id="icon-software-kalman">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 4l4 4M4 8l4-4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="6" cy="6" r="1" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M3 3l1 1M8 3l1 1M3 9l1-1M8 9l1-1" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <!-- Communication Protocol Icons -->
        <g id="icon-software-protocol">
          <rect x="2" y="4" width="8" height="4" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 6h4M4 5.5v1M8 5.5v1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="2" cy="6" r="0.5" fill="currentColor"/>
          <circle cx="10" cy="6" r="0.5" fill="currentColor"/>
        </g>
        
        <g id="icon-software-can">
          <rect x="2" y="4" width="8" height="4" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 5v2M6 5v2M8 5v2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M2 6h1M9 6h1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-software-mqtt">
          <path d="M6 2v2M6 8v2M2 6h2M8 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <circle cx="6" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4v4M4 6h4" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
          <circle cx="6" cy="6" r="0.5" fill="currentColor"/>
        </g>
        
        <!-- Algorithm & Processing Icons -->
        <g id="icon-software-fft">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 8l1-3 1 2 1-4 1 1 1-2 1 3" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 8h6" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <g id="icon-software-ml">
          <circle cx="6" cy="6" r="4" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="4" cy="4" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="4" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="4" cy="8" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="8" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M4.8 4.8l2.4 2.4M7.2 4.8l-2.4 2.4M4.8 7.2l2.4-2.4M7.2 7.2l-2.4-2.4" stroke="currentColor" stroke-width="0.8"/>
        </g>
        
        <!-- System Software Icons -->
        <g id="icon-software-rtos">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3" y="4" width="1.5" height="4" fill="currentColor" opacity="0.7"/>
          <rect x="5.25" y="3" width="1.5" height="5" fill="currentColor" opacity="0.7"/>
          <rect x="7.5" y="5" width="1.5" height="3" fill="currentColor" opacity="0.7"/>
          <path d="M3 8h6" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <g id="icon-software-boot">
          <rect x="2" y="3" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 4v4M4 6h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <path d="M6 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="6" cy="1.5" r="0.5" fill="currentColor"/>
        </g>

        <!-- Small arrow marker for FSM -->
        <marker id="arrowhead-small" markerWidth="6" markerHeight="4" 
                refX="5" refY="2" orient="auto" markerUnits="strokeWidth">
          <polygon points="0 0, 6 2, 0 4" fill="currentColor" />
        </marker>

        <!-- ========== MILESTONE 11 PHASE 4: SYSTEM TEMPLATE ICONS ========== -->
        
        <!-- Template Category Icon -->
        <g id="icon-template">
          <rect x="2" y="2" width="8" height="8" rx="1.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3.5" y="3.5" width="2" height="2" rx="0.3" fill="currentColor" opacity="0.7"/>
          <rect x="6.5" y="3.5" width="2" height="2" rx="0.3" fill="currentColor" opacity="0.7"/>
          <rect x="3.5" y="6.5" width="2" height="2" rx="0.3" fill="currentColor" opacity="0.7"/>
          <rect x="6.5" y="6.5" width="2" height="2" rx="0.3" fill="currentColor" opacity="0.7"/>
          <path d="M4.5 5.5h3M5.5 4.5v3" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <!-- System Template Icons -->
        <g id="icon-template-motor-control">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="4" cy="6" r="1.2" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="6.5" y="5" width="2" height="2" rx="0.3" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5.2 6h1.3M4 4.8v2.4" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
          <path d="M7.5 4v1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-template-sensor-array">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="4" cy="4" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="4" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="4" cy="8" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <circle cx="8" cy="8" r="0.8" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M4.8 4.8l2.4 2.4M7.2 4.8l-2.4 2.4" stroke="currentColor" stroke-width="0.6"/>
        </g>
        
        <g id="icon-template-linear-motion">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="3.5" cy="6" r="1" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="5" y="5" width="3" height="2" rx="0.3" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M8.5 6h1M4.5 6h0.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M9 5.5l0.5 0.5-0.5 0.5" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-template-control-loop">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="6" cy="6" r="2.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M6 3.5v1M6 7.5v1M3.5 6h1M7.5 6h1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="6" cy="6" r="0.8" fill="currentColor" opacity="0.7"/>
          <path d="M5 5l2 2M7 5l-2 2" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
        </g>
        
        <g id="icon-template-smart-actuator">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="5" cy="5" r="1.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="6.5" y="4.5" width="2" height="1" rx="0.2" fill="none" stroke="currentColor" stroke-width="0.8"/>
          <rect x="3" y="7" width="6" height="1" rx="0.2" fill="currentColor" opacity="0.5"/>
          <path d="M6 3v1M5 3.5v1M4 3.5v1" stroke="currentColor" stroke-width="0.8" stroke-linecap="round"/>
          <circle cx="5" cy="5" r="0.5" fill="currentColor"/>
        </g>
        
        <!-- ========== TOOLBAR ICONS ========== -->
        
        <!-- File Operations -->
        <g id="icon-new">
          <rect x="3" y="2" width="6" height="8" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M5 4h2M5 6h2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <g id="icon-save">
          <path d="M3 2h5l2 2v6a1 1 0 01-1 1H4a1 1 0 01-1-1V3a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="5" y="6" width="2" height="3" rx="0.3" fill="currentColor"/>
          <rect x="4" y="2" width="4" height="2" fill="currentColor" opacity="0.3"/>
        </g>
        
        <g id="icon-load">
          <path d="M2 4h3l1-1h4v6a1 1 0 01-1 1H3a1 1 0 01-1-1V4z" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 4V3a1 1 0 011-1h5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <g id="icon-export">
          <rect x="3" y="4" width="6" height="5" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M6 2v5M4 4l2-2 2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <!-- Edit Operations -->
        <g id="icon-undo">
          <path d="M4 5h4a2 2 0 110 4H6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M4 3l-2 2 2 2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-redo">
          <path d="M8 5H4a2 2 0 100 4h2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M8 3l2 2-2 2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-copy">
          <rect x="4" y="4" width="5" height="5" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3" y="3" width="5" height="5" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <g id="icon-paste">
          <rect x="4" y="4" width="5" height="5" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M5 2h2v2H5z" fill="currentColor"/>
        </g>
        
        <!-- Create Operations -->
        <g id="icon-block">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M5 5h2M5 7h2" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <g id="icon-text">
          <path d="M3 3h6M6 3v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 9h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-note">
          <path d="M3 2h4l2 2v6a1 1 0 01-1 1H4a1 1 0 01-1-1V3a1 1 0 011-1z" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M7 2v2h2" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M4 5h4M4 7h2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <g id="icon-child">
          <rect x="1" y="2" width="4" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="7" y="2" width="4" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="4" y="7" width="4" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M3 5v1h6V5M6 6v1" stroke="currentColor" stroke-width="1"/>
        </g>
        
        <!-- Selection -->
        <g id="icon-select-all">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2,1"/>
          <path d="M4 6l1.5 1.5L8 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-clear">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
        </g>
        
        <g id="icon-group">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3" y="3" width="2.5" height="2.5" rx="0.3" fill="currentColor" opacity="0.5"/>
          <rect x="6.5" y="3" width="2.5" height="2.5" rx="0.3" fill="currentColor" opacity="0.5"/>
          <rect x="3" y="6.5" width="2.5" height="2.5" rx="0.3" fill="currentColor" opacity="0.5"/>
          <rect x="6.5" y="6.5" width="2.5" height="2.5" rx="0.3" fill="currentColor" opacity="0.5"/>
        </g>
        
        <g id="icon-ungroup">
          <rect x="2" y="2" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="7" y="2" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="2" y="7" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="7" y="7" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
        </g>
        
        <!-- Layout -->
        <g id="icon-auto-layout">
          <rect x="2" y="2" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="7" y="2" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="2" y="7" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <rect x="7" y="7" width="3" height="3" rx="0.5" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M5 3.5h2M5 8.5h2M3.5 5v2M8.5 5v2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <g id="icon-align-left">
          <path d="M2 2v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <rect x="4" y="3" width="5" height="2" rx="0.5" fill="currentColor" opacity="0.7"/>
          <rect x="4" y="7" width="3" height="2" rx="0.5" fill="currentColor" opacity="0.7"/>
        </g>
        
        <g id="icon-align-center">
          <path d="M6 2v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          <rect x="3" y="3" width="6" height="2" rx="0.5" fill="currentColor" opacity="0.7"/>
          <rect x="4" y="7" width="4" height="2" rx="0.5" fill="currentColor" opacity="0.7"/>
        </g>
        
        <g id="icon-distribute">
          <rect x="2" y="4" width="2" height="4" rx="0.3" fill="currentColor" opacity="0.7"/>
          <rect x="5" y="4" width="2" height="4" rx="0.3" fill="currentColor" opacity="0.7"/>
          <rect x="8" y="4" width="2" height="4" rx="0.3" fill="currentColor" opacity="0.7"/>
          <path d="M2 3h8M2 9h8" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <!-- View -->
        <g id="icon-ruler">
          <path d="M2 2h8v3H2z" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 2v1.5M6 2v2M8 2v1.5" stroke="currentColor" stroke-width="1"/>
          <path d="M2 7h8v3H2z" fill="none" stroke="currentColor" stroke-width="1"/>
          <path d="M4 7v1M6 7v1.5M8 7v1" stroke="currentColor" stroke-width="0.8"/>
        </g>
        
        <g id="icon-comment">
          <path d="M2 3h8v5H5l-2 2v-2H2z" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
          <path d="M4 5h4M4 6.5h2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </g>
        
        <g id="icon-zoom">
          <circle cx="5.5" cy="5.5" r="3.5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8 8l2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </g>
        
        <g id="icon-hash">
          <path d="M4 2v8M8 2v8M2 4h8M2 8h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-check">
          <circle cx="6" cy="6" r="5" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 6l1.5 1.5L8 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        
        <g id="icon-ecad">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <path d="M4 4h4M4 6h4M4 8h2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <circle cx="8" cy="8" r="1" fill="currentColor"/>
        </g>
        
        <g id="icon-link">
          <path d="M5 7l2-2M4 6c-1.5 0-2.5 1.5-1 3s3 .5 3-1M8 6c1.5 0 2.5-1.5 1-3s-3-.5-3 1" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </g>
        
        <g id="icon-templates">
          <rect x="2" y="2" width="8" height="8" rx="1" fill="none" stroke="currentColor" stroke-width="1.5"/>
          <rect x="3" y="3" width="2" height="2" rx="0.2" fill="currentColor" opacity="0.5"/>
          <rect x="7" y="3" width="2" height="2" rx="0.2" fill="currentColor" opacity="0.5"/>
          <rect x="3" y="7" width="2" height="2" rx="0.2" fill="currentColor" opacity="0.5"/>
          <rect x="7" y="7" width="2" height="2" rx="0.2" fill="currentColor" opacity="0.5"/>
        </g>
        
        <g id="icon-bulk">
          <path d="M2 4h3v3H2zM7 4h3v3H7zM2 8h3v2H2zM7 8h3v2H7z" fill="currentColor" opacity="0.5"/>
          <path d="M4 2L6 4 8 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
      </defs>
      <g id="connections-layer"></g>
      <g id="blocks-layer"></g>
    </svg>

    <!-- ========== CANVAS MINIMAP ========== -->
    <div id="minimap-container" aria-hidden="true" style="
      position: fixed; bottom: 12px; right: 12px; z-index: 500;
      width: 160px; height: 110px;
      background: rgba(30, 30, 30, 0.85);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      cursor: pointer;
      user-select: none;
    ">
      <canvas id="minimap-canvas" width="160" height="110"></canvas>
    </div>
    
    <!-- Status Legend -->
    <div class="status-legend">
      <h4>Block Status</h4>
      <div class="status-item">
        <div class="status-color status-placeholder"></div>
        <span>Placeholder</span>
      </div>
      <div class="status-item">
        <div class="status-color status-planned"></div>
        <span>Planned</span>
      </div>
      <div class="status-item">
        <div class="status-color status-in-work"></div>
        <span>In-Work</span>
      </div>
      <div class="status-item">
        <div class="status-color status-implemented"></div>
        <span>Implemented</span>
      </div>
      <div class="status-item">
        <div class="status-color status-verified"></div>
        <span>Verified</span>
      </div>
    </div>
    
    <!-- Connection Type Legend -->
    <div class="connection-legend">
      <h4>Connection Types</h4>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-power" stroke-width="3"/>
          <polygon points="30,6 26,3 26,9" class="connection-power"/>
        </svg>
        <span>
          <svg width="14" height="14" viewBox="0 0 12 12" class="connection-icon">
            <use href="#icon-power"/>
          </svg>
          Power
        </span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-data" stroke-width="2" stroke-dasharray="8,4"/>
          <polygon points="30,6 26,3 26,9" class="connection-data"/>
        </svg>
        <span>
          <svg width="14" height="14" viewBox="0 0 12 12" class="connection-icon">
            <use href="#icon-data"/>
          </svg>
          Data
        </span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-electrical" stroke-width="2" stroke-dasharray="4,2"/>
          <polygon points="30,6 26,3 26,9" class="connection-electrical"/>
        </svg>
        <span>
          <svg width="14" height="14" viewBox="0 0 12 12" class="connection-icon">
            <use href="#icon-electrical"/>
          </svg>
          Electrical
        </span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-mechanical" stroke-width="2" stroke-dasharray="12,6"/>
          <line x1="30" y1="3" x2="26" y2="6" class="connection-mechanical" stroke-width="2"/>
          <line x1="30" y1="9" x2="26" y2="6" class="connection-mechanical" stroke-width="2"/>
        </svg>
        <span>
          <svg width="14" height="14" viewBox="0 0 12 12" class="connection-icon">
            <use href="#icon-mechanical"/>
          </svg>
          Mechanical
        </span>
      </div>
      
      <h4 class="fusion-legend-section">Arrow Types</h4>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-generic" stroke-width="2"/>
          <polygon points="30,6 26,3 26,9" class="connection-generic"/>
        </svg>
        <span>→ Forward</span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-generic" stroke-width="2"/>
          <polygon points="30,6 26,3 26,9" class="connection-generic"/>
          <polygon points="0,6 4,3 4,9" class="connection-generic"/>
        </svg>
        <span>↔ Bidirectional</span>
      </div>
      <div class="connection-item">
        <svg width="40" height="12" viewBox="0 0 40 12">
          <line x1="0" y1="6" x2="30" y2="6" class="connection-generic" stroke-width="2"/>
        </svg>
        <span>— No Arrow</span>
      </div>
    </div>
    
    <!-- Rule Results Panel -->
    <div class="rule-panel" id="rule-panel" style="display:none;">
      <h4>Rule Check Results</h4>
      <div id="rule-results"></div>
    </div>
  </div>
  
  <!-- ========== DOCUMENT DIALOGS ========== -->
  <!-- Save As dialog -->
  <div id="save-as-overlay" class="fusion-modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="save-as-title">
    <div class="fusion-modal">
      <h3 id="save-as-title">Save As…</h3>
      <label class="fusion-label" for="save-as-name">Document name:</label>
      <input type="text" id="save-as-name" class="fusion-input" placeholder="My Diagram" style="width:100%;margin:8px 0;">
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="save-as-cancel" class="fusion-button">Cancel</button>
        <button id="save-as-confirm" class="fusion-button primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Open Document picker -->
  <div id="open-doc-overlay" class="fusion-modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="open-doc-title">
    <div class="fusion-modal">
      <h3 id="open-doc-title">Open Document</h3>
      <div id="open-doc-list" style="max-height:220px;overflow-y:auto;margin:8px 0;"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="open-doc-cancel" class="fusion-button">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ========== EXPORT OPTIONS DIALOG ========== -->

  <!-- ========== CRASH RECOVERY PROMPT ========== -->
  <div id="recovery-overlay" class="fusion-modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="recovery-title">
    <div class="fusion-modal" style="min-width:360px;max-width:440px;">
      <h3 style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:22px;" aria-hidden="true">&#9888;</span> <span id="recovery-title">Recover Unsaved Work?</span>
      </h3>
      <p style="margin:8px 0 16px;font-size:12px;color:var(--text-secondary,#ccc);line-height:1.5;">
        A previous session was not saved properly. An auto-backup of your diagram was found.
        Would you like to recover it?
      </p>
      <p id="recovery-timestamp" style="margin:0 0 16px;font-size:11px;color:var(--text-secondary,#999);">
        Backup saved at: —
      </p>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="recovery-discard" class="fusion-button" style="padding:6px 14px;">Discard</button>
        <button id="recovery-restore" class="fusion-button fusion-button-primary" style="padding:6px 14px;">Recover</button>
      </div>
    </div>
  </div>

  <!-- ========== LOADING SPINNER OVERLAY ========== -->
  <div id="loading-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:250000;
    display:none;align-items:center;justify-content:center;flex-direction:column;">
    <div style="width:48px;height:48px;border:4px solid rgba(255,255,255,0.2);border-top:4px solid var(--fusion-accent,#0078d4);
      border-radius:50%;animation:fsb-spin 0.8s linear infinite;"></div>
    <div id="loading-message" style="margin-top:14px;color:#fff;font-size:13px;font-family:Arial,sans-serif;">Loading…</div>
  </div>
  <style>
    @keyframes fsb-spin { to { transform: rotate(360deg); } }
  </style>
  <script>
    // Global loading spinner helpers
    window.showLoadingSpinner = function(msg) {
      var el = document.getElementById('loading-overlay');
      if (!el) return;
      var msgEl = document.getElementById('loading-message');
      if (msgEl) msgEl.textContent = msg || 'Loading\u2026';
      el.style.display = 'flex';
    };
    window.hideLoadingSpinner = function() {
      var el = document.getElementById('loading-overlay');
      if (el) el.style.display = 'none';
    };
  </script>

  <!-- ========== KEYBOARD SHORTCUTS HELP ========== -->
  <div id="shortcuts-overlay" class="fusion-modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="shortcuts-title">
    <div class="fusion-modal" style="min-width:420px;max-width:560px;max-height:80vh;overflow-y:auto;">
      <h3 style="display:flex;align-items:center;justify-content:space-between;">
        <span id="shortcuts-title">Keyboard Shortcuts</span>
        <button id="shortcuts-close" class="fusion-button" style="padding:2px 8px;font-size:14px;" title="Close" aria-label="Close shortcuts dialog">&times;</button>
      </h3>

      <div style="font-size:12px;line-height:1.8;">
        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">File</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+N</kbd></td><td>New Diagram</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+S</kbd></td><td>Save</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Shift+S</kbd></td><td>Save As</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+O</kbd></td><td>Open / Load</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Shift+O</kbd></td><td>Open Named Document</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">Edit</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Z</kbd></td><td>Undo</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Y</kbd> / <kbd>Ctrl+Shift+Z</kbd></td><td>Redo</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+C</kbd></td><td>Copy</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+V</kbd></td><td>Paste</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+D</kbd></td><td>Duplicate</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Delete</kbd> / <kbd>Backspace</kbd></td><td>Delete Selected</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">Create</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>B</kbd> / <kbd>Insert</kbd></td><td>Add Block</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>C</kbd></td><td>Connect Mode</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">Navigate</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Shift+&uarr;</kbd></td><td>Go Up (parent diagram)</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Shift+&darr;</kbd></td><td>Drill Down (child diagram)</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+Shift+N</kbd></td><td>Create Child Diagram</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">View</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+=</kbd></td><td>Zoom In</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+-</kbd></td><td>Zoom Out</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+0</kbd></td><td>Fit to View</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+F</kbd></td><td>Search / Filter</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>M</kbd></td><td>Toggle Minimap</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">Selection</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Ctrl+A</kbd></td><td>Select All</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Escape</kbd></td><td>Clear Selection</td></tr>
        </tbody></table>

        <h4 style="margin:10px 0 4px;color:var(--fusion-accent);font-size:13px;">Connection Types</h4>
        <table style="width:100%;border-collapse:collapse;"><tbody>
          <tr><td style="padding:2px 6px;"><kbd>Shift+P</kbd></td><td>Power</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Shift+D</kbd></td><td>Data</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Shift+E</kbd></td><td>Electrical</td></tr>
          <tr><td style="padding:2px 6px;"><kbd>Shift+M</kbd></td><td>Mechanical</td></tr>
        </tbody></table>
      </div>

      <p style="margin:12px 0 0;font-size:11px;color:var(--fusion-text-secondary);text-align:center;">
        Press <kbd>?</kbd> to toggle this dialog
      </p>
    </div>
  </div>

  <div id="export-overlay" class="fusion-modal-overlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="export-title">
    <div class="fusion-modal" style="min-width:340px;max-width:460px;">
      <h3 id="export-title">Export Reports</h3>
      <p style="color:var(--fusion-text-secondary);font-size:12px;margin:0 0 12px 0;">
        Select which reports to export and choose a destination folder.
      </p>

      <!-- Format checkboxes -->
      <div style="max-height:200px;overflow-y:auto;margin-bottom:12px;">
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-markdown" checked> Markdown Report (.md)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-html" checked> HTML Report (.html)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-csv" checked> Pin Map CSV (.csv)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-header" checked> Pin Map C Header (.h)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-bom-csv" checked> BOM CSV (.csv)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-bom-json"> BOM JSON (.json)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-assembly-md"> Assembly Sequence (.md)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-assembly-json"> Assembly Sequence (.json)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-connection-matrix"> Connection Matrix (.csv)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-svg"> SVG Diagram (.svg)
        </label>
        <label style="display:block;padding:4px 0;font-size:13px;cursor:pointer;">
          <input type="checkbox" id="exp-pdf"> PDF Report (.pdf)
        </label>
      </div>

      <!-- Quick-select buttons -->
      <div style="display:flex;gap:6px;margin-bottom:12px;">
        <button id="exp-select-all" class="fusion-button" style="font-size:11px;padding:3px 8px;">Select All</button>
        <button id="exp-select-none" class="fusion-button" style="font-size:11px;padding:3px 8px;">Select None</button>
      </div>

      <!-- Output path display -->
      <div style="margin-bottom:12px;">
        <label class="fusion-label" style="font-size:12px;">Destination folder:</label>
        <div style="display:flex;gap:6px;align-items:center;margin-top:4px;">
          <input type="text" id="exp-folder-path" class="fusion-input" readonly
                 style="flex:1;font-size:11px;"
                 value="(default — exports/ in add-in folder)" />
          <button id="exp-browse-folder" class="fusion-button" style="font-size:11px;padding:3px 8px;">Browse…</button>
        </div>
      </div>

      <!-- Action buttons -->
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="exp-cancel" class="fusion-button">Cancel</button>
        <button id="exp-confirm" class="fusion-button primary">Export</button>
      </div>
    </div>
  </div>

  <!-- ========== BLOCK CONTEXT MENU ========== -->
  <div id="block-context-menu" class="fusion-context-menu" style="position:fixed; z-index:1000000;">
    <!-- Block-specific items -->
    <div id="ctx-rename" class="fusion-context-menu-item" data-needs-block>
      <span class="ctx-icon">✏️</span> Rename
      <span class="ctx-shortcut">Dbl-click</span>
    </div>
    <div id="ctx-properties" class="fusion-context-menu-item" data-needs-block>
      <span class="ctx-icon">⚙️</span> Properties…
    </div>
    <div class="fusion-context-menu-item has-submenu" data-needs-block>
      <span class="ctx-icon">🔷</span> Type
      <span class="ctx-arrow">▸</span>
      <div class="fusion-context-submenu">
        <div class="fusion-context-menu-item" data-set-type="Generic">Generic</div>
        <div class="fusion-context-menu-item" data-set-type="Electrical">Electrical</div>
        <div class="fusion-context-menu-item" data-set-type="Mechanical">Mechanical</div>
        <div class="fusion-context-menu-item" data-set-type="Software">Software</div>
      </div>
    </div>
    <div class="fusion-context-menu-item has-submenu" data-needs-block>
      <span class="ctx-icon">📊</span> Status
      <span class="ctx-arrow">▸</span>
      <div class="fusion-context-submenu">
        <div class="fusion-context-menu-item" data-set-status="Placeholder">Placeholder</div>
        <div class="fusion-context-menu-item" data-set-status="Planned">Planned</div>
        <div class="fusion-context-menu-item" data-set-status="In-Work">In-Work</div>
        <div class="fusion-context-menu-item" data-set-status="Implemented">Implemented</div>
        <div class="fusion-context-menu-item" data-set-status="Verified">Verified</div>
      </div>
    </div>
    <div class="fusion-context-menu-item has-submenu" data-needs-block>
      <span class="ctx-icon">⬡</span> Shape
      <span class="ctx-arrow">▸</span>
      <div class="fusion-context-submenu">
        <div class="fusion-context-menu-item" data-set-shape="rectangle">▭ Rectangle</div>
        <div class="fusion-context-menu-item" data-set-shape="rounded">▢ Rounded</div>
        <div class="fusion-context-menu-item" data-set-shape="diamond">◇ Diamond</div>
        <div class="fusion-context-menu-item" data-set-shape="circle">○ Ellipse</div>
        <div class="fusion-context-menu-item" data-set-shape="hexagon">⬡ Hexagon</div>
        <div class="fusion-context-menu-item" data-set-shape="parallelogram">▱ Parallelogram</div>
        <div class="fusion-context-menu-item" data-set-shape="cylinder">⊙ Cylinder</div>
        <div class="fusion-context-menu-item" data-set-shape="triangle">△ Triangle</div>
      </div>
    </div>
    <div class="fusion-context-menu-separator" data-needs-block></div>
    <div id="ctx-connect-from" class="fusion-context-menu-item" data-needs-block>
      <span class="ctx-icon">🔗</span> Connect to…
      <span class="ctx-shortcut">C</span>
    </div>
    <div class="fusion-context-menu-separator" data-needs-block></div>
    <div id="ctx-delete" class="fusion-context-menu-item danger" data-needs-block>
      <span class="ctx-icon">🗑️</span> Delete
      <span class="ctx-shortcut">Del</span>
    </div>
    <!-- Empty-space items -->
    <div id="ctx-add-block" class="fusion-context-menu-item" data-needs-empty>
      <span class="ctx-icon">➕</span> Add Block
    </div>
    <div id="ctx-fit-view" class="fusion-context-menu-item" data-needs-empty>
      <span class="ctx-icon">🔍</span> Fit to View
    </div>
  </div>
  <!-- Connection context menu (right-click a connection line) -->
  <div id="connection-context-menu" class="fusion-context-menu" style="position:fixed; z-index:1000000;">
    <div class="fusion-context-menu-item has-submenu">
      <span class="ctx-icon">🔌</span> Type
      <span class="ctx-arrow">▸</span>
      <div class="fusion-context-submenu">
        <div class="fusion-context-menu-item" data-conn-type="auto">Auto</div>
        <div class="fusion-context-menu-item" data-conn-type="power">⚡ Power</div>
        <div class="fusion-context-menu-item" data-conn-type="data">📡 Data</div>
        <div class="fusion-context-menu-item" data-conn-type="electrical">⚙️ Electrical</div>
        <div class="fusion-context-menu-item" data-conn-type="mechanical">🔩 Mechanical</div>
      </div>
    </div>
    <div class="fusion-context-menu-item has-submenu">
      <span class="ctx-icon">➡️</span> Direction
      <span class="ctx-arrow">▸</span>
      <div class="fusion-context-submenu">
        <div class="fusion-context-menu-item" data-conn-direction="forward">→ Forward</div>
        <div class="fusion-context-menu-item" data-conn-direction="backward">← Backward</div>
        <div class="fusion-context-menu-item" data-conn-direction="bidirectional">↔ Bidirectional</div>
        <div class="fusion-context-menu-item" data-conn-direction="none">— None</div>
      </div>
    </div>
    <div class="fusion-context-menu-separator"></div>
    <div id="ctx-conn-select-blocks" class="fusion-context-menu-item">
      <span class="ctx-icon">🎯</span> Select Connected Blocks
    </div>
    <div class="fusion-context-menu-separator"></div>
    <div id="ctx-conn-delete" class="fusion-context-menu-item danger">
      <span class="ctx-icon">🗑️</span> Delete Connection
      <span class="ctx-shortcut">Del</span>
    </div>
  </div>

  <!-- Undo History Panel -->
  <div id="history-panel" class="history-panel">
    <div class="history-panel-header">
      <span>⏱ History <span class="history-count" id="history-count"></span></span>
      <button class="history-close" id="history-close" title="Close">&times;</button>
    </div>
    <div class="history-panel-list" id="history-list">
      <!-- Dynamically populated -->
    </div>
  </div>

  <div id="import-dialog" role="dialog" aria-modal="true" aria-labelledby="import-dialog-title"
       style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                                  background: var(--fusion-panel-bg, #2b2b2b); border: 2px solid var(--fusion-panel-border, #555); 
                                  padding: 20px; z-index: 10000; min-width: 500px; color: var(--fusion-text-primary, #ffffff); 
                                  border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
    <h3 id="import-dialog-title" style="color: var(--fusion-text-primary, #ffffff); margin-top: 0;">Import Diagram</h3>
    
    <div style="margin-bottom: 15px;">
      <label>
        <input type="radio" name="import-type" value="mermaid" checked> 
        Import from Mermaid Flowchart
      </label>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>
        <input type="radio" name="import-type" value="csv"> 
        Import from CSV
      </label>
    </div>
    
    <!-- Mermaid Import -->
    <div id="mermaid-import" style="margin-bottom: 15px;">
      <label for="mermaid-text" style="color: var(--fusion-text-primary, #ffffff); font-weight: 500;">Mermaid Flowchart Text:</label><br>
      <textarea id="mermaid-text" rows="8" cols="60" placeholder="flowchart TD&#10;    A[Start] --> B{Decision}&#10;    B -->|Yes| C[Process]&#10;    B -->|No| D[End]&#10;    C --> D" 
                style="background: var(--fusion-input-bg, #1e1e1e); color: var(--fusion-text-primary, #ffffff); 
                       border: 1px solid var(--fusion-input-border, #555); border-radius: 4px; padding: 8px; 
                       font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; width: 100%; box-sizing: border-box;"></textarea>
    </div>
    
    <!-- CSV Import -->
    <div id="csv-import" style="display: none; margin-bottom: 15px;">
      <label for="csv-blocks" style="color: var(--fusion-text-primary, #ffffff); font-weight: 500;">Blocks CSV (name,type,x,y,status):</label><br>
      <textarea id="csv-blocks" rows="4" cols="60" placeholder="name,type,x,y,status&#10;Power Supply,PowerSupply,100,100,Verified&#10;Microcontroller,Microcontroller,300,100,Planned"
                style="background: var(--fusion-input-bg, #1e1e1e); color: var(--fusion-text-primary, #ffffff); 
                       border: 1px solid var(--fusion-input-border, #555); border-radius: 4px; padding: 8px; 
                       font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; width: 100%; box-sizing: border-box;"></textarea>
      
      <br><br>
      <label for="csv-connections" style="color: var(--fusion-text-primary, #ffffff); font-weight: 500;">Connections CSV (from,to,kind,protocol):</label><br>
      <textarea id="csv-connections" rows="4" cols="60" placeholder="from,to,kind,protocol&#10;Power Supply,Microcontroller,electrical,3.3V"
                style="background: var(--fusion-input-bg, #1e1e1e); color: var(--fusion-text-primary, #ffffff); 
                       border: 1px solid var(--fusion-input-border, #555); border-radius: 4px; padding: 8px; 
                       font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; width: 100%; box-sizing: border-box;"></textarea>
    </div>
    
    <div style="text-align: right;">
      <button id="btn-import-cancel" style="margin-right: 10px; background: var(--fusion-button-bg, #404040); 
                                             color: var(--fusion-text-primary, #ffffff); border: 1px solid var(--fusion-border-primary, #555); 
                                             padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="btn-import-ok" style="background: var(--fusion-accent-blue, #0078d4); color: #ffffff; 
                                        border: 1px solid var(--fusion-accent-blue, #0078d4); padding: 8px 16px; 
                                        border-radius: 4px; cursor: pointer; font-weight: 500;">Import</button>
    </div>
  </div>
  
  <!-- Dialog Overlay -->
  <div id="dialog-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                   background: rgba(0,0,0,0.5); z-index: 9999;"></div>
  
  <!-- ========== FUSION 360 KEYBOARD SHORTCUTS & ACCESSIBILITY - PHASE 3 ========== -->
  <script>
    // Professional Keyboard Shortcuts System
    class FusionKeyboardManager {
      constructor() {
        this.shortcuts = {
          // File Operations
          'Ctrl+N': () => this.triggerAction('btn-new', 'New Diagram'),
          'Ctrl+S': () => this.triggerAction('btn-save', 'Save Diagram'),
          'Ctrl+O': () => this.triggerAction('btn-load', 'Load Diagram'),
          
          // Edit Operations
          'Ctrl+Z': () => this.triggerAction('btn-undo', 'Undo'),
          'Ctrl+Y': () => this.triggerAction('btn-redo', 'Redo'),
          'Ctrl+Shift+Z': () => this.triggerAction('btn-redo', 'Redo'),
          
          // Navigation
          'Ctrl+F': () => this.focusSearch(),
          'Escape': () => this.clearSelection(),
          'Delete': () => this.deleteSelected(),
          'Backspace': () => this.deleteSelected(),
          
          // Hierarchy Navigation
          'Ctrl+Up': () => this.triggerAction('btn-go-up', 'Go Up'),
          'Ctrl+Down': () => this.triggerAction('btn-drill-down', 'Drill Down'),
          'Ctrl+Shift+N': () => this.triggerAction('btn-create-child', 'Create Child'),
          
          // Block Operations
          'Ctrl+A': () => this.selectAll(),
          'Ctrl+D': () => this.duplicateSelected(),
          'Insert': () => this.triggerAction('btn-add-block-ribbon', 'Add Block'),
          
          // View Controls
          'Ctrl+0': () => this.resetZoom(),
          'Ctrl+=': () => this.zoomIn(),
          'Ctrl+-': () => this.zoomOut(),
          
          // Connection Types (with Shift)
          'Shift+P': () => this.setConnectionType('power'),
          'Shift+D': () => this.setConnectionType('data'),
          'Shift+E': () => this.setConnectionType('electrical'),
          'Shift+M': () => this.setConnectionType('mechanical'),
        };
        
        this.init();
      }
      
      init() {
        document.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.createKeyboardHints();
        this.setupAccessibility();
      }
      
      handleKeydown(e) {
        // Don't handle shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
          if (e.key === 'Escape') {
            e.target.blur();
          }
          return;
        }
        
        const key = this.getShortcutKey(e);
        const handler = this.shortcuts[key];
        
        if (handler) {
          e.preventDefault();
          handler();
          this.showKeyboardFeedback(key);
        }
      }
      
      getShortcutKey(e) {
        const parts = [];
        if (e.ctrlKey) parts.push('Ctrl');
        if (e.shiftKey) parts.push('Shift');
        if (e.altKey) parts.push('Alt');
        
        let key = e.key;
        if (key === ' ') key = 'Space';
        parts.push(key);
        
        return parts.join('+');
      }
      
      triggerAction(buttonId, actionName) {
        const button = document.getElementById(buttonId);
        if (button && !button.disabled) {
          button.click();
          this.showToast(`${actionName} (Keyboard Shortcut)`);
        } else if (button && button.disabled) {
          this.showToast(`${actionName} not available`, 'warning');
        }
      }
      
      focusSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.focus();
          searchInput.select();
          this.showToast('Search focused (Ctrl+F)');
        }
      }
      
      clearSelection() {
        // Clear any selections
        document.querySelectorAll('.block.selected').forEach(block => {
          block.classList.remove('selected');
        });
        this.showToast('Selection cleared');
      }
      
      selectAll() {
        document.querySelectorAll('.block').forEach(block => {
          block.classList.add('selected');
        });
        this.showToast('All blocks selected (Ctrl+A)');
      }
      
      deleteSelected() {
        const selected = document.querySelectorAll('.block.selected');
        if (selected.length > 0) {
          // Add deletion animation before removing
          selected.forEach(block => {
            block.style.animation = 'blockDisappear 0.3s ease-in forwards';
            setTimeout(() => block.remove(), 300);
          });
          this.showToast(`Deleted ${selected.length} block(s)`);
        }
      }
      
      setConnectionType(type) {
        const select = document.getElementById('connection-type-select');
        if (select) {
          select.value = type;
          select.dispatchEvent(new Event('change'));
          this.showToast(`Connection type: ${type.charAt(0).toUpperCase() + type.slice(1)}`);
        }
      }
      
      showKeyboardFeedback(shortcut) {
        // Visual feedback for keyboard shortcuts
        const feedback = document.createElement('div');
        feedback.className = 'keyboard-feedback';
        feedback.textContent = shortcut;
        feedback.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,123,204,0.9);
          color: white;
          padding: 8px 16px;
          border-radius: 4px;
          font-family: var(--fusion-font-family);
          font-size: 14px;
          font-weight: 500;
          z-index: 10000;
          opacity: 0;
          animation: shortcutFeedback 0.8s ease-out;
        `;
        
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 800);
      }
      
      showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fusion-toast ${type}`;
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: var(--fusion-panel-bg);
          color: var(--fusion-text-primary);
          border: 1px solid var(--fusion-panel-border);
          padding: 12px 16px;
          border-radius: var(--fusion-radius-medium);
          font-family: var(--fusion-font-family);
          font-size: var(--fusion-font-size-normal);
          box-shadow: var(--fusion-shadow-medium);
          z-index: 10000;
          opacity: 0;
          transform: translateY(20px);
          animation: toastSlideIn 0.3s ease-out forwards;
        `;
        
        if (type === 'warning') {
          toast.style.borderColor = 'var(--fusion-status-warning)';
          toast.style.background = 'var(--fusion-status-warning-bg)';
        }
        
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.animation = 'toastSlideOut 0.3s ease-in forwards';
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }
      
      createKeyboardHints() {
        const hints = document.createElement('div');
        hints.className = 'keyboard-hint';
        hints.innerHTML = `
          <div>Press <kbd>Ctrl+K</kbd> to show all shortcuts</div>
        `;
        document.body.appendChild(hints);
        
        // Show hints on first load, then hide
        setTimeout(() => hints.classList.add('show'), 1000);
        setTimeout(() => hints.classList.remove('show'), 4000);
      }
      
      setupAccessibility() {
        // Add ARIA labels and keyboard navigation
        document.querySelectorAll('.block').forEach((block, index) => {
          block.setAttribute('tabindex', '0');
          block.setAttribute('role', 'button');
          block.setAttribute('aria-label', `Block ${index + 1}`);
        });
        
        // Enhanced focus management
        document.addEventListener('focusin', (e) => {
          if (e.target.classList.contains('block')) {
            e.target.style.outline = '2px solid var(--fusion-accent-blue)';
            e.target.style.outlineOffset = '2px';
          }
        });
        
        document.addEventListener('focusout', (e) => {
          if (e.target.classList.contains('block')) {
            e.target.style.outline = '';
            e.target.style.outlineOffset = '';
          }
        });
      }
    }
    
    // Initialize keyboard manager when DOM is ready — only if the modular
    // ToolbarManager has NOT already registered its own shortcuts, to avoid
    // double-firing Delete, Escape, Ctrl+Z, etc.
    // NOTE: The modular system sets window._systemBlocksInitialized = true
    // asynchronously, so we defer the check until the next microtask.
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (!window._systemBlocksInitialized) {
          window.fusionKeyboard = new FusionKeyboardManager();
        }
      }, 500);
    });
    
    // Visual debug function
    function debugLog(message) {
      // Debug logging disabled for clean interface

    }

    // ── Custom Tooltip for Ribbon Buttons ─────────────────────────
    // Fusion 360 CEF does not display native title-attribute tooltips.
    // This creates a lightweight floating tooltip on hover.
    (function initRibbonTooltips() {
      const tip = document.createElement('div');
      tip.className = 'ribbon-tooltip';
      document.body.appendChild(tip);

      let hideTimer = null;
      const SHOW_DELAY = 400; // ms before tooltip appears
      let showTimer = null;

      function show(btn) {
        const text = btn.getAttribute('title');
        if (!text) return;
        tip.textContent = text;
        const rect = btn.getBoundingClientRect();
        tip.style.left = Math.max(4, rect.left + rect.width / 2 - tip.offsetWidth / 2) + 'px';
        tip.style.top  = (rect.bottom + 4) + 'px';
        tip.style.display = 'block';
      }

      document.addEventListener('mouseover', (e) => {
        const btn = e.target.closest('.ribbon-button-large, .ribbon-button-small');
        if (!btn || !btn.getAttribute('title')) return;
        clearTimeout(hideTimer);
        clearTimeout(showTimer);
        showTimer = setTimeout(() => show(btn), SHOW_DELAY);
      });

      document.addEventListener('mouseout', (e) => {
        const btn = e.target.closest('.ribbon-button-large, .ribbon-button-small');
        if (!btn) return;
        clearTimeout(showTimer);
        hideTimer = setTimeout(() => { tip.style.display = 'none'; }, 80);
      });
    })();
  </script>
  
  <!-- Add CSS for new animations -->
  <style>
    @keyframes blockDisappear {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    
    @keyframes shortcutFeedback {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
    
    @keyframes toastSlideIn {
      0% { opacity: 0; transform: translateY(20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes toastSlideOut {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
    
    @keyframes slideInFromRight {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutToRight {
      0% { transform: translateX(0); opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    
    kbd {
      background: var(--fusion-bg-tertiary);
      border: 1px solid var(--fusion-border-secondary);
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 11px;
      font-family: monospace;
      color: var(--fusion-text-primary);
    }

    /* ========== MILESTONE 11: ADVANCED BLOCK TYPE SELECTOR - PHASE 1 ========== */
    
    /* Block Type Dropdown Container */
    .block-type-dropdown {
      position: relative;
      display: inline-block;
    }
    
    /* Dropdown Arrow Animation */
    .dropdown-arrow {
      margin-left: var(--fusion-spacing-xs);
      transition: transform var(--fusion-transition-fast);
    }
    
    .block-type-dropdown.open .dropdown-arrow {
      transform: rotate(180deg);
    }
    
    /* Professional Block Type Menu */
    .block-type-menu {
      position: fixed;
      top: 60px;
      left: 120px;
      min-width: 320px;
      max-height: 500px;
      background: var(--fusion-panel-bg);
      border: 1px solid var(--fusion-panel-border);
      border-radius: var(--fusion-radius-medium);
      box-shadow: var(--fusion-shadow-heavy);
      overflow-y: auto;
      z-index: 999999 !important;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all var(--fusion-transition-fast) cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
    }
    
    .block-type-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    /* Block Category Headers */
    .block-category {
      padding: var(--fusion-spacing-sm) 0;
      border-bottom: 1px solid var(--fusion-border-secondary);
    }
    
    .block-category:last-child {
      border-bottom: none;
    }
    
    .block-category h4 {
      margin: 0 0 var(--fusion-spacing-sm) 0;
      padding: 0 var(--fusion-spacing-md);
      font-size: var(--fusion-font-size-normal);
      font-weight: 600;
      color: var(--fusion-text-primary);
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-xs);
    }
    
    /* Professional Block Type Items */
    .block-type-item {
      display: flex;
      align-items: center;
      padding: var(--fusion-spacing-sm) var(--fusion-spacing-md);
      cursor: pointer;
      transition: all var(--fusion-transition-fast);
      gap: var(--fusion-spacing-sm);
    }
    
    .block-type-item:hover:not(.disabled) {
      background: var(--fusion-bg-hover);
      transform: translateX(2px);
    }
    
    .block-type-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Block Icons */
    .block-icon {
      width: 24px;
      height: 24px;
      border-radius: var(--fusion-radius-small);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .block-icon::before {
      content: "";
      position: absolute;
      inset: 2px;
      background: rgba(255,255,255,0.2);
      border-radius: var(--fusion-radius-small);
    }
    
    /* Block Information */
    .block-info {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
    }
    
    .block-name {
      font-size: var(--fusion-font-size-normal);
      font-weight: 500;
      color: var(--fusion-text-primary);
      line-height: 1.2;
    }
    
    .block-desc {
      font-size: var(--fusion-font-size-small);
      color: var(--fusion-text-secondary);
      line-height: 1.2;
      margin-top: 2px;
    }
    
    /* Enhanced Block Visual States */
    .block-type-item:not(.disabled):active {
      transform: translateX(4px) scale(0.98);
    }
    
    /* Block Type Selection Animation */
    .block-type-item.selected {
      background: rgba(0, 123, 204, 0.1);
      border-left: 3px solid var(--fusion-accent-blue);
      padding-left: calc(var(--fusion-spacing-md) - 3px);
    }
    
    /* Scrollbar Styling */
    .block-type-menu::-webkit-scrollbar {
      width: 6px;
    }
    
    .block-type-menu::-webkit-scrollbar-track {
      background: var(--fusion-bg-secondary);
    }
    
    .block-type-menu::-webkit-scrollbar-thumb {
      background: var(--fusion-border-secondary);
      border-radius: 3px;
    }
    
    .block-type-menu::-webkit-scrollbar-thumb:hover {
      background: var(--fusion-border-hover);
    }

    /* ========== SPECIALIZED BLOCK RENDERING ========== */
    .specialized-block {
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
      stroke-width: 2px !important;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .specialized-block:hover {
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.3));
      transform: scale(1.02);
    }

    .specialized-text {
      font-weight: 600;
      font-size: 12px;
      fill: var(--fusion-text-primary);
    }

    .block-type-indicator {
      font-family: var(--fusion-font-family);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    /* Block category styling */
    .specialized-block[data-category="electrical"] {
      stroke: var(--fusion-primary-color);
    }

    .specialized-block[data-category="mechanical"] {
      stroke: #16A085;
    }

    .specialized-block[data-category="software"] {
      stroke: #8E44AD;
    }

    .specialized-block[data-category="firmware"] {
      stroke: #D35400;
    }

    .specialized-block[data-category="software"] {
      stroke: #8E44AD;
    }

    /* Connection points styling */
    .connection-point {
      stroke: rgba(255, 255, 255, 0.8);
      stroke-width: 1px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .connection-point:hover {
      r: 6px;
      stroke-width: 2px;
    }

    /* Animation effects */
    @keyframes blockCreated {
      0% {
        opacity: 0;
        transform: scale(0.8) rotate(-5deg);
      }
      50% {
        opacity: 0.8;
        transform: scale(1.1) rotate(2deg);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    @keyframes floatingEffect {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-2px);
      }
    }

    .block-group.new {
      animation: blockCreated 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .block-group.floating .specialized-block {
      animation: floatingEffect 3s ease-in-out infinite;
      animation-delay: calc(var(--block-index, 0) * 0.2s);
    }

    /* Specifications tooltip styling */
    .specs-tooltip {
      background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
      border: 1px solid var(--fusion-primary-color);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      min-width: 250px;
    }

    .specs-tooltip h4 {
      color: var(--fusion-primary-color);
      margin: 0 0 10px 0;
      font-size: 14px;
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      padding-bottom: 5px;
    }

    .specs-tooltip div {
      font-size: 12px;
      margin: 4px 0;
      line-height: 1.4;
    }

    .spec-preview {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      padding: 8px;
      margin-top: 8px;
    }

    .spec-section {
      margin-bottom: 12px;
    }

    .spec-section:last-child {
      margin-bottom: 0;
    }

    .spec-section h5 {
      color: var(--fusion-accent-blue);
      margin: 0 0 6px 0;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(52, 152, 219, 0.2);
      padding-bottom: 3px;
    }

    /* Enhanced mechanical connection point styling */
    .connection-point[stroke-dasharray] {
      animation: rotate 2s linear infinite;
    }

    @keyframes rotate {
      from { stroke-dashoffset: 0; }
      to { stroke-dashoffset: 6; }
    }

    /* Category-specific block enhancements */
    .specialized-block[data-category="mechanical"] .block-type-indicator {
      color: #16A085;
    }

    .specialized-block[data-category="software"] .block-type-indicator {
      color: #8E44AD;
    }

    /* Software-specific connection point animations */
    .connection-point[stroke-dasharray*="3,1"] {
      animation: softwareFlow 1.5s linear infinite;
    }

    @keyframes softwareFlow {
      from { stroke-dashoffset: 0; }
      to { stroke-dashoffset: 8; }
    }

    /* Enhanced software block styling */
    .specialized-block[data-category="software"] {
      filter: drop-shadow(0 4px 12px rgba(142, 68, 173, 0.3));
    }

    .specialized-block[data-category="software"]:hover {
      filter: drop-shadow(0 6px 16px rgba(142, 68, 173, 0.4));
    }

    /* ========== TEMPLATE SYSTEM STYLING ========== */
    .template-block {
      filter: drop-shadow(0 6px 20px rgba(231, 76, 60, 0.3));
    }

    .template-block .specialized-block {
      stroke: var(--template-color);
      stroke-width: 3px;
      stroke-dasharray: 8,2;
    }

    .template-connection {
      opacity: 0.8;
      stroke-dasharray: 10,5;
      animation: templateConnectionFlow 3s linear infinite;
    }

    @keyframes templateConnectionFlow {
      from { stroke-dashoffset: 0; }
      to { stroke-dashoffset: 30; }
    }

    @keyframes connectionFlow {
      0%, 100% { stroke-dashoffset: 100; }
      50% { stroke-dashoffset: 0; }
    }

    .template-created {
      animation: templateCreated 1s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes templateCreated {
      0% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Template info tooltip styling */
    .template-info {
      background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
      border: 2px solid #E74C3C;
      border-radius: 12px;
      box-shadow: 0 12px 36px rgba(231, 76, 60, 0.4);
      color: white;
    }

    .template-info h4 {
      color: white;
      margin: 0 0 12px 0;
      font-size: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 8px;
    }

    .template-info p {
      margin: 0 0 12px 0;
      opacity: 0.9;
      line-height: 1.4;
    }

    .template-stats {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      padding: 8px;
      margin: 8px 0;
    }

    .template-stats div {
      font-size: 12px;
      margin: 3px 0;
    }

    .template-specs {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 6px;
      padding: 8px;
      margin-top: 8px;
    }

    .template-specs div {
      font-size: 11px;
      margin: 2px 0;
      opacity: 0.9;
    }

    /* Enhanced block type menu for templates */
    .block-category h4:contains("System Templates") {
      background: linear-gradient(90deg, #E74C3C, #F39C12);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }
  </style>
  <script src="./types/electrical-blocks.js"></script>
  <script src="./types/mechanical-blocks.js"></script>
  <script src="./types/software-blocks.js"></script>
  <script src="./types/block-templates.js"></script>
  
  <!-- ========== MILESTONE 11: BLOCK TYPE SELECTOR FUNCTIONALITY - ALL PHASES COMPLETE ========== -->
  <script>
    // Professional Block Type Manager for Milestone 11
    const paletteLogger = window.getSystemBlocksLogger
      ? window.getSystemBlocksLogger()
      : {
          debug: () => {},
          info: () => {},
          warn: () => {},
          error: () => {}
        };

    class AdvancedBlockTypeManager {
      constructor() {
        this.currentBlockType = null;
        this.blockTypeMenu = null;
        this.isMenuOpen = false;
        this.init();
      }
      
      init() {
        this.blockTypeMenu = document.getElementById('block-type-menu');
        this.setupEventListeners();
        this.setupKeyboardShortcuts();
      }
      
      setupEventListeners() {
        // Block type button toggle
        const blockTypeBtn = document.getElementById('btn-block-types');
        if (blockTypeBtn) {
          blockTypeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleBlockTypeMenu();
          });
        }
        
        // Block type selection
        document.querySelectorAll('.block-type-item:not(.disabled)').forEach(item => {
          item.addEventListener('click', (e) => {
            const blockType = e.currentTarget.dataset.type;
            this.selectBlockType(blockType);
            this.closeBlockTypeMenu();
          });
          
          // Hover preview
          item.addEventListener('mouseenter', (e) => {
            const blockType = e.currentTarget.dataset.type;
            this.showBlockTypePreview(blockType, e);
          });
          
          item.addEventListener('mouseleave', (e) => {
            this.hideBlockTypePreview();
          });
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.block-type-dropdown')) {
            this.closeBlockTypeMenu();
          }
        });
        
        // Note: Add Block functionality is handled by the main editor in palette.js
        // Don't override the existing functionality
      }
      
      setupKeyboardShortcuts() {
        // Add to existing keyboard manager
        if (window.fusionKeyboard) {
          window.fusionKeyboard.shortcuts['Shift+B'] = () => this.toggleBlockTypeMenu();
          window.fusionKeyboard.shortcuts['Ctrl+Shift+1'] = () => this.quickSelectType('microcontroller-arduino');
          window.fusionKeyboard.shortcuts['Ctrl+Shift+2'] = () => this.quickSelectType('microcontroller-esp32');
          window.fusionKeyboard.shortcuts['Ctrl+Shift+P'] = () => this.quickSelectType('power-supply-linear');
        }
      }
      
      toggleBlockTypeMenu() {
        if (this.isMenuOpen) {
          this.closeBlockTypeMenu();
        } else {
          this.openBlockTypeMenu();
        }
      }
      
      openBlockTypeMenu() {
        // Position the dropdown based on button location
        const blockTypeBtn = document.getElementById('btn-block-types');
        const btnRect = blockTypeBtn.getBoundingClientRect();
        
        // Position dropdown below the button
        this.blockTypeMenu.style.top = (btnRect.bottom + 5) + 'px';
        this.blockTypeMenu.style.left = btnRect.left + 'px';
        
        this.blockTypeMenu.classList.add('show');
        document.querySelector('.block-type-dropdown').classList.add('open');
        this.isMenuOpen = true;
        
        // Focus first item for keyboard navigation
        const firstItem = this.blockTypeMenu.querySelector('.block-type-item:not(.disabled)');
        if (firstItem) {
          firstItem.focus();
        }
        
        this.showToast('Block type selector opened (↑↓ to navigate, Enter to select)', 'info');
      }
      
      closeBlockTypeMenu() {
        this.blockTypeMenu.classList.remove('show');
        document.querySelector('.block-type-dropdown').classList.remove('open');
        this.isMenuOpen = false;
      }
      
      selectBlockType(blockType) {
        paletteLogger.debug('selectBlockType called with:', blockType);
        
        // Check if editor is ready
        if (!window.editor || !window.editor.isInitialized) {
          paletteLogger.warn('Editor not ready yet');
          this.showToast('Editor not ready - please wait a moment and try again', 'warning');
          return;
        }
        
        this.currentBlockType = blockType;
        
        // Update button appearance
        const blockTypeBtn = document.getElementById('btn-block-types');
        
        // Try to get type info from all available libraries and templates
        let typeInfo = null;
        let isTemplate = false;
        
        // Check if it's a template
        if (blockType.startsWith('template-') && typeof BlockTemplateSystem !== 'undefined') {
          typeInfo = BlockTemplateSystem.getTemplate(blockType);
          isTemplate = true;
        }
        
        // If not a template, check component libraries
        if (!typeInfo) {
          typeInfo = ElectricalBlockTypes.getType(blockType);
        }
        if (!typeInfo && typeof MechanicalBlockTypes !== 'undefined') {
          typeInfo = MechanicalBlockTypes.getType(blockType);
        }
        if (!typeInfo && typeof SoftwareBlockTypes !== 'undefined') {
          typeInfo = SoftwareBlockTypes.getType(blockType);
        }
        
        if (typeInfo) {
          blockTypeBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 12 12">
              <use href="#icon-${typeInfo.icon || (isTemplate ? 'template' : 'block-advanced')}"/>
            </svg>
            ${typeInfo.name}
            <svg width="12" height="12" viewBox="0 0 12 12" class="dropdown-arrow">
              <path d="M3 5l3 3 3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `;
          blockTypeBtn.style.borderColor = typeInfo.color;
          blockTypeBtn.style.color = typeInfo.color;
        }
        
        // Create block or template
        if (isTemplate) {
          this.createFromTemplate(blockType);
        } else {
          this.createSpecializedBlock(blockType);
        }
        
        this.showToast(`${isTemplate ? 'Created template' : 'Selected'}: ${typeInfo?.name || blockType}`, 'info');
      }
      
      quickSelectType(blockType) {
        this.selectBlockType(blockType);
        this.closeBlockTypeMenu();
      }
      

      
      createFromTemplate(templateId) {
        if (typeof BlockTemplateSystem === 'undefined') return;
        
        const basePosition = { 
          x: 200 + Math.random() * 300, 
          y: 200 + Math.random() * 200 
        };
        
        const templateResult = BlockTemplateSystem.createFromTemplate(templateId, basePosition);
        if (!templateResult) return;
        
        const canvas = document.getElementById('svg-canvas');
        const blocksLayer = document.getElementById('blocks-layer');
        const connectionsLayer = document.getElementById('connections-layer');
        
        // Create all blocks from template
        const createdBlockElements = [];
        templateResult.blocks.forEach((block, index) => {
          const blockElement = this.addBlockToCanvas(block, true);
          createdBlockElements.push(blockElement);
          
          // Add template-specific styling
          blockElement.classList.add('template-block');
          blockElement.setAttribute('data-template', templateId);
          blockElement.style.setProperty('--template-color', templateResult.template.color);
        });
        
        // Create connections between blocks
        templateResult.connections.forEach(conn => {
          this.createTemplateConnection(conn, createdBlockElements);
        });
        
        // Show template information
        this.showTemplateInfo(templateResult.template, templateResult.blocks.length);
        
        // Add template completion animation
        setTimeout(() => {
          createdBlockElements.forEach((element, index) => {
            setTimeout(() => {
              element.classList.add('template-created');
            }, index * 100);
          });
        }, 500);
      }

      createSpecializedBlock(blockType) {
        // Try to get type info from all available libraries
        let typeInfo = ElectricalBlockTypes.getType(blockType);
        if (!typeInfo && typeof MechanicalBlockTypes !== 'undefined') {
          typeInfo = MechanicalBlockTypes.getType(blockType);
        }
        if (!typeInfo && typeof SoftwareBlockTypes !== 'undefined') {
          typeInfo = SoftwareBlockTypes.getType(blockType);
        }
        
        if (!typeInfo) return;
        
        // Create specialized block with full specifications
        const block = {
          id: window.editor ? window.editor.generateId() : this.generateBlockId(),
          name: typeInfo.name,
          type: blockType,
          category: typeInfo.category,
          x: 150 + Math.random() * 300,
          y: 150 + Math.random() * 200,
          width: 120,
          height: 60,
          status: 'Planned',
          links: [],
          attributes: {
            specifications: typeInfo.specifications,
            description: typeInfo.description
          },
          interfaces: (typeInfo.interfaces && typeInfo.interfaces.length > 0) ? 
            typeInfo.interfaces.map((iface, index) => {
              // Ensure interface has the correct structure for rendering
              return {
                id: window.editor ? window.editor.generateId() : `${this.generateBlockId()}_${iface.id || iface.name}`,
                name: iface.name,
                kind: iface.kind || iface.type || 'data',
                direction: iface.direction || 'input',
                port: {
                  side: iface.side || (iface.direction === 'output' ? 'right' : 'left'),
                  index: iface.index !== undefined ? iface.index : index
                },
                params: iface.params || {}
              };
            }) : 
            // Fallback to standard interfaces if none provided
            [
              {
                id: window.editor ? window.editor.generateId() : `${this.generateBlockId()}_vcc`,
                name: 'VCC',
                kind: 'power',
                direction: 'input',
                port: { side: 'left', index: 0 },
                params: {}
              },
              {
                id: window.editor ? window.editor.generateId() : `${this.generateBlockId()}_gnd`,
                name: 'GND', 
                kind: 'power',
                direction: 'input',
                port: { side: 'left', index: 1 },
                params: {}
              },
              {
                id: window.editor ? window.editor.generateId() : `${this.generateBlockId()}_out`,
                name: 'OUT',
                kind: 'data',
                direction: 'output', 
                port: { side: 'right', index: 0 },
                params: {}
              }
            ],
          pinout: typeInfo.pinout || null,
          visualStyle: {
            color: typeInfo.color,
            icon: typeInfo.icon
          },
          _isNewBlock: true  // Flag for animation
        };
        
        // Add specialized block directly to avoid interface conflicts
        if (window.editor) {
          try {
            paletteLogger.debug('Creating specialized block:', typeInfo.name);
            
            // Save state for undo
            window.editor.saveState();
            
            // Snap position to grid
            const snappedPos = window.editor.snapPointToGrid(block.x, block.y);
            block.x = snappedPos.x;
            block.y = snappedPos.y;
            
            // Add the complete block directly to the diagram
            paletteLogger.debug('Adding block to diagram. Current block count:', window.editor.diagram.blocks.length);
            window.editor.diagram.blocks.push(block);
            paletteLogger.debug('Block added. New block count:', window.editor.diagram.blocks.length);
            paletteLogger.debug('Block structure:', block);
            
            // Render the diagram to show the new block with proper event listeners
            paletteLogger.debug('Rendering diagram...');
            window.editor.renderDiagram();
            paletteLogger.debug('Diagram rendered successfully');

            paletteLogger.debug('Specialized block created and rendered successfully');
          } catch (error) {
            paletteLogger.error('Error creating specialized block:', error);
            this.showToast('Error creating block: ' + error.message, 'error');
          }
        } else {
          paletteLogger.error('window.editor is not available');
          this.showToast('Editor not ready - please try again', 'error');
        }
        this.showToast(`Created ${typeInfo.name}`, 'info');
        
        // Show specifications tooltip
        setTimeout(() => {
          this.showBlockSpecifications(block);
        }, 500);
      }
      
      addBlockToCanvas(block, isSpecialized = false) {
        const canvas = document.getElementById('svg-canvas');
        const blocksLayer = document.getElementById('blocks-layer');
        
        // Create SVG group for the block
        const blockGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        blockGroup.classList.add('block-group');
        blockGroup.setAttribute('data-block-id', block.id);
        blockGroup.setAttribute('transform', `translate(${block.x}, ${block.y})`);
        
        // Create block rectangle with specialized styling
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.classList.add('block');
        if (isSpecialized) {
          rect.classList.add('specialized-block');
          rect.setAttribute('data-type', block.type);
          rect.setAttribute('data-category', block.category);
        }
        
        // Set dimensions based on block type
        const width = isSpecialized ? 120 : 100;
        const height = isSpecialized ? 80 : 60;
        
        rect.setAttribute('x', -width/2);
        rect.setAttribute('y', -height/2);
        rect.setAttribute('width', width);
        rect.setAttribute('height', height);
        rect.setAttribute('rx', isSpecialized ? 8 : 6);
        
        // Apply specialized styling
        if (isSpecialized && block.visualStyle) {
          rect.style.fill = `${block.visualStyle.color}20`; // 20% opacity
          rect.style.stroke = block.visualStyle.color;
          rect.style.strokeWidth = '2';
        }
        
        // Create text label
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.classList.add('block-text');
        if (isSpecialized) {
          text.classList.add('specialized-text');
        }
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.textContent = block.name;
        
        // Add type indicator for specialized blocks
        if (isSpecialized) {
          const typeIndicator = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          typeIndicator.classList.add('block-type-indicator');
          typeIndicator.setAttribute('text-anchor', 'middle');
          typeIndicator.setAttribute('dominant-baseline', 'middle');
          typeIndicator.setAttribute('y', '15');
          typeIndicator.style.fontSize = '10px';
          typeIndicator.style.opacity = '0.7';
          typeIndicator.textContent = block.category.toUpperCase();
          blockGroup.appendChild(typeIndicator);
        }
        
        // Add connection points for interfaces
        if (block.interfaces && block.interfaces.length > 0) {
          this.addConnectionPoints(blockGroup, block.interfaces, width, height);
        }
        
        blockGroup.appendChild(rect);
        blockGroup.appendChild(text);
        blocksLayer.appendChild(blockGroup);
        
        // Add animation
        blockGroup.classList.add('new');
        if (isSpecialized) {
          blockGroup.classList.add('floating');
        }
        
        // Store block data
        blockGroup.blockData = block;
        
        return blockGroup;
      }
      
      addConnectionPoints(blockGroup, interfaces, width, height) {
        interfaces.forEach((iface, index) => {
          const point = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          point.classList.add('connection-point');
          point.setAttribute('data-interface-id', iface.id);
          point.setAttribute('data-interface-kind', iface.kind);
          
          // Position points around the block perimeter
          const angle = (index / interfaces.length) * 2 * Math.PI;
          const x = Math.cos(angle) * (width/2 + 5);
          const y = Math.sin(angle) * (height/2 + 5);
          
          point.setAttribute('cx', x);
          point.setAttribute('cy', y);
          point.setAttribute('r', '4');
          
          // Color code by interface type with enhanced colors for all categories
          const colorMap = {
            'power': '#E74C3C',
            'data': '#3498DB', 
            'electrical': '#F39C12',
            'mechanical': '#16A085'
          };
          point.style.fill = colorMap[iface.kind] || '#BDC3C7';
          
          // Enhanced software interface styling
          if (iface.kind === 'data' && block.category === 'software') {
            point.style.strokeWidth = '2';
            point.style.stroke = '#8E44AD';
            
            // Protocol-specific styling
            if (iface.protocol === 'api_call' || iface.protocol === 'function_call') {
              point.setAttribute('stroke-dasharray', '3,1');
            } else if (iface.protocol === 'interrupt') {
              point.style.fill = '#E74C3C';
              point.setAttribute('stroke', '#E74C3C');
            } else if (iface.protocol === 'dma') {
              point.setAttribute('stroke-width', '3');
              point.style.opacity = '0.8';
            }
          }
          
          // Add mechanical-specific styling
          if (iface.kind === 'mechanical') {
            point.setAttribute('stroke-width', '2');
            if (iface.type === 'rotational') {
              point.setAttribute('stroke-dasharray', '2,1');
            } else if (iface.type === 'linear') {
              point.setAttribute('rx', '2'); // Make rectangular for linear
            } else if (iface.type === 'force') {
              point.setAttribute('stroke', '#E67E22');
              point.setAttribute('stroke-width', '3');
            }
          }
          
          blockGroup.appendChild(point);
        });
      }
      
      showBlockSpecifications(block) {
        if (!block.attributes?.specifications) return;
        
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip specs-tooltip show';
        
        // Get properties from all available libraries
        let typeInfo = ElectricalBlockTypes.getType(block.type);
        if (!typeInfo && typeof MechanicalBlockTypes !== 'undefined') {
          typeInfo = MechanicalBlockTypes.getType(block.type);
        }
        if (!typeInfo && typeof SoftwareBlockTypes !== 'undefined') {
          typeInfo = SoftwareBlockTypes.getType(block.type);
        }
        
        let mechanicalPropsHtml = '';
        if (typeInfo?.mechanicalProperties) {
          mechanicalPropsHtml = `
            <div class="spec-section">
              <h5>Mechanical Properties</h5>
              ${Object.entries(typeInfo.mechanicalProperties).map(([key, value]) => 
                `<div><strong>${key}:</strong> ${value}</div>`
              ).join('')}
            </div>
          `;
        }

        let softwarePropsHtml = '';
        if (typeInfo?.softwareProperties) {
          softwarePropsHtml = `
            <div class="spec-section">
              <h5>Software Properties</h5>
              ${Object.entries(typeInfo.softwareProperties).map(([key, value]) => 
                `<div><strong>${key}:</strong> ${value}</div>`
              ).join('')}
            </div>
          `;
        }

        let algorithmsHtml = '';
        if (typeInfo?.algorithms) {
          algorithmsHtml = `
            <div class="spec-section">
              <h5>Algorithms</h5>
              ${Object.entries(typeInfo.algorithms).map(([key, value]) => 
                `<div><strong>${key}:</strong> ${value}</div>`
              ).join('')}
            </div>
          `;
        }
        
        tooltip.innerHTML = `
          <h4>${block.name} Specifications</h4>
          <div class="spec-section">
            <h5>General Specifications</h5>
            ${Object.entries(block.attributes.specifications).map(([key, value]) => 
              `<div><strong>${key}:</strong> ${value}</div>`
            ).join('')}
          </div>
          ${mechanicalPropsHtml}
          ${softwarePropsHtml}
          ${algorithmsHtml}
        `;
        
        tooltip.style.left = `${block.x + 100}px`;
        tooltip.style.top = `${block.y - 50}px`;
        
        document.body.appendChild(tooltip);
        
        setTimeout(() => tooltip.remove(), 7000); // Longer display for more content
      }
      
      showBlockTypePreview(blockType, event) {
        // Clear any existing preview
        this.hideBlockTypePreview();
        
        // Try to get type info from all available libraries
        let typeInfo = ElectricalBlockTypes.getType(blockType);
        if (!typeInfo && typeof MechanicalBlockTypes !== 'undefined') {
          typeInfo = MechanicalBlockTypes.getType(blockType);
        }
        if (!typeInfo && typeof SoftwareBlockTypes !== 'undefined') {
          typeInfo = SoftwareBlockTypes.getType(blockType);
        }
        
        if (!typeInfo) return;
        
        // Show preview tooltip with specifications
        this.currentPreview = document.createElement('div');
        this.currentPreview.className = 'tooltip info show';
        this.currentPreview.innerHTML = `
          <h4>${typeInfo.name}</h4>
          <p>${typeInfo.description}</p>
          <div class="spec-preview">
            ${Object.entries(typeInfo.specifications).slice(0, 3).map(([key, value]) => 
              `<div><strong>${key}:</strong> ${value}</div>`
            ).join('')}
          </div>
        `;
        
        const rect = event.target.getBoundingClientRect();
        this.currentPreview.style.left = `${rect.right + 10}px`;
        this.currentPreview.style.top = `${rect.top}px`;
        
        document.body.appendChild(this.currentPreview);
      }
      
      hideBlockTypePreview() {
        if (this.currentPreview) {
          this.currentPreview.remove();
          this.currentPreview = null;
        }
      }
      
      generateBlockId() {
        return 'block_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      
      createTemplateConnection(connection, blockElements) {
        const connectionsLayer = document.getElementById('connections-layer');
        
        // Find source and target block elements by template index
        const sourceElement = blockElements[connection.from.component];
        const targetElement = blockElements[connection.to.component];
          
        if (!sourceElement || !targetElement) return;
        
        // Create connection line
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.classList.add('connection', 'template-connection');
        line.setAttribute('data-connection-type', connection.type);
        
        // Get block positions
        const sourceRect = sourceElement.getBBox();
        const targetRect = targetElement.getBBox();
        const sourceTransform = sourceElement.getAttribute('transform');
        const targetTransform = targetElement.getAttribute('transform');
        
        // Extract positions from transform
        const sourcePos = this.extractPosition(sourceTransform);
        const targetPos = this.extractPosition(targetTransform);
        
        line.setAttribute('x1', sourcePos.x);
        line.setAttribute('y1', sourcePos.y);
        line.setAttribute('x2', targetPos.x);
        line.setAttribute('y2', targetPos.y);
        
        // Style based on connection type
        const connectionStyles = {
          'power_connection': { stroke: '#E74C3C', strokeWidth: '3' },
          'control_signal': { stroke: '#3498DB', strokeWidth: '2' },
          'feedback_signal': { stroke: '#F39C12', strokeWidth: '2' },
          'data_connection': { stroke: '#8E44AD', strokeWidth: '2' },
          'mechanical_rotational': { stroke: '#16A085', strokeWidth: '2.5' },
          'mechanical_linear': { stroke: '#16A085', strokeWidth: '2.5' }
        };
        
        const style = connectionStyles[connection.type] || { stroke: '#BDC3C7', strokeWidth: '2' };
        line.setAttribute('stroke', style.stroke);
        line.setAttribute('stroke-width', style.strokeWidth);
        line.setAttribute('stroke-dasharray', '5,3');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        
        connectionsLayer.appendChild(line);
        
        // Add connection animation
        line.style.strokeDashoffset = '100';
        line.style.animation = 'connectionFlow 2s ease-in-out infinite';
      }
      
      extractPosition(transform) {
        if (!transform) return { x: 0, y: 0 };
        const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
        return match ? { 
          x: parseFloat(match[1]), 
          y: parseFloat(match[2]) 
        } : { x: 0, y: 0 };
      }
      
      showTemplateInfo(template, blockCount) {
        const info = document.createElement('div');
        info.className = 'tooltip template-info show';
        info.innerHTML = `
          <h4>🎯 ${template.name}</h4>
          <p>${template.description}</p>
          <div class="template-stats">
            <div><strong>Components:</strong> ${blockCount}</div>
            <div><strong>Category:</strong> ${template.category}</div>
            <div><strong>Type:</strong> ${template.subcategory}</div>
          </div>
          <div class="template-specs">
            ${Object.entries(template.specifications).map(([key, value]) => 
              `<div><strong>${key}:</strong> ${value}</div>`
            ).join('')}
          </div>
        `;
        
        info.style.left = '50px';
        info.style.top = '100px';
        info.style.maxWidth = '350px';
        
        document.body.appendChild(info);
        
        setTimeout(() => info.remove(), 8000);
      }

      showToast(message, type = 'info') {
        // Use existing toast system from keyboard manager
        if (window.fusionKeyboard) {
          window.fusionKeyboard.showToast(message, type);
        }
      }
    }
    
    // Initialize Advanced Block Type Manager
    document.addEventListener('DOMContentLoaded', () => {
      window.blockTypeManager = new AdvancedBlockTypeManager();
    });
  </script>

  <style>
    /* === PALETTE TABS, PANELS, AND STATUS BAR === */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .sb-tabbar {
      display: flex;
      gap: var(--fusion-spacing-sm);
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      background: var(--fusion-gradient-primary);
      border-bottom: 1px solid var(--fusion-border-primary);
      position: sticky;
      top: 0;
      z-index: 10000;
      backdrop-filter: blur(6px);
    }

    .sb-tabbar .sb-tab {
      appearance: none;
      border: 1px solid var(--fusion-button-border);
      background: var(--fusion-gradient-button);
      color: var(--fusion-text-primary);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-md);
      cursor: pointer;
      font-size: var(--fusion-font-size-normal);
      font-family: var(--fusion-font-family);
      font-weight: var(--fusion-font-weight-medium);
      box-shadow: var(--fusion-shadow-button);
      transition: all var(--fusion-transition) var(--fusion-ease-in-out);
    }

    .sb-tabbar .sb-tab:hover {
      background: var(--fusion-gradient-button-hover);
      border-color: var(--fusion-border-hover);
      transform: translateY(-1px);
    }

    .sb-tabbar .sb-tab[aria-selected="true"] {
      background: var(--fusion-accent-blue);
      color: var(--fusion-text-inverse);
      border-color: var(--fusion-accent-blue);
      box-shadow: var(--fusion-shadow-button), 0 0 0 1px rgba(255,255,255,0.12);
    }

    .sb-tabbar .sb-tab:focus-visible {
      outline: 2px solid var(--fusion-accent-blue);
      outline-offset: 2px;
    }

    .sb-panel {
      position: fixed;
      left: var(--fusion-spacing-sm);
      right: var(--fusion-spacing-sm);
      top: 96px;
      bottom: 42px;
      display: none;
      opacity: 0;
      transform: translateY(6px);
      background: var(--fusion-bg-secondary);
      border: 1px solid var(--fusion-border-primary);
      border-radius: var(--fusion-radius-medium);
      box-shadow: var(--fusion-shadow-panel);
      padding: var(--fusion-spacing-md);
      overflow: auto;
      will-change: opacity, transform;
      transition: opacity var(--fusion-transition) var(--fusion-ease-in-out),
                  transform var(--fusion-transition) var(--fusion-ease-in-out);
    }

    /* Diagram panel is the canvas area; keep it minimal */
    #panel-diagram {
      position: static;
      display: block;
      padding: 0;
      border: none;
      background: transparent;
      box-shadow: none;
    }

    .sb-panel.show { display: block; opacity: 1; transform: translateY(0); z-index: 200000; }

    .sb-section {
      margin-bottom: var(--fusion-spacing-lg);
      background: var(--fusion-gradient-subtle);
      border: 1px solid var(--fusion-border-light);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-md);
    }

    .sb-section h3, .sb-section h4 {
      margin-top: 0;
      margin-bottom: var(--fusion-spacing-sm);
      color: var(--fusion-text-primary);
    }

    .sb-controls {
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-sm);
      margin-bottom: var(--fusion-spacing-sm);
    }

    .sb-controls .sb-tab {
      border: 1px solid var(--fusion-button-border);
      background: var(--fusion-gradient-button);
      color: var(--fusion-text-primary);
      border-radius: var(--fusion-radius-medium);
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-md);
      cursor: pointer;
      font-size: var(--fusion-font-size-normal);
      font-weight: var(--fusion-font-weight-medium);
      transition: all var(--fusion-transition) var(--fusion-ease-in-out);
    }

    .sb-controls .sb-tab:hover {
      background: var(--fusion-gradient-button-hover);
      border-color: var(--fusion-border-hover);
    }

    .sb-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--fusion-spacing-xs);
    }

    .sb-list li {
      background: var(--fusion-bg-tertiary);
      border: 1px solid var(--fusion-border-light);
      border-radius: var(--fusion-radius-small);
      padding: var(--fusion-spacing-sm);
      color: var(--fusion-text-secondary);
    }

    .sb-status {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      gap: var(--fusion-spacing-sm);
      padding: var(--fusion-spacing-xs) var(--fusion-spacing-sm);
      background: var(--fusion-gradient-primary);
      border-top: 1px solid var(--fusion-border-primary);
      box-shadow: var(--fusion-shadow-light);
      z-index: 10000;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: var(--fusion-spacing-xs);
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--fusion-bg-tertiary);
      color: var(--fusion-text-secondary);
      border: 1px solid var(--fusion-border-light);
      font-size: var(--fusion-font-size-small);
      line-height: 1.4;
    }

    /* High-contrast pill variants */
    .pill-success { background: #1b5e20; color: #eaf5ea; border-color: #2e7d32; }
    .pill-warning { background: #7f4d00; color: #fff3e0; border-color: #ff9800; }
    .pill-error   { background: #5c0000; color: #ffebee; border-color: #f44336; }
    .pill-info    { background: #0d47a1; color: #e3f2fd; border-color: #2196f3; }
  </style>

  <!-- Overlay Panels -->
  <section id="panel-home" class="sb-panel" role="tabpanel" aria-labelledby="tab-home" aria-hidden="true">
    <div class="sb-section">
      <h3>Welcome</h3>
      <div class="sb-controls">
        <button id="action-new" class="sb-tab">New Diagram</button>
        <button id="action-load" class="sb-tab">Load Diagram</button>
      </div>
    </div>
    <div class="sb-section">
      <h4>Quick Tips</h4>
      <ul class="sb-list">
        <li>Use Linking to attach blocks to CAD components.</li>
        <li>Run Validation to find orphans and incompatible interfaces.</li>
        <li>Export reports for sharing (JSON/CSV/HTML).</li>
      </ul>
    </div>
  </section>

  <section id="panel-diagram" class="sb-panel" role="tabpanel" aria-labelledby="tab-diagram" aria-hidden="false"></section>

  <section id="panel-linking" class="sb-panel" role="tabpanel" aria-labelledby="tab-linking" aria-hidden="true">
    <div class="sb-section">
      <h3>Link Selected Block to CAD</h3>
      <div class="sb-controls">
        <button id="action-link-selected" class="sb-tab">Start CAD Selection</button>
        <span id="linking-status" class="pill">Idle</span>
      </div>
      <p class="sr-only" id="linking-aria" aria-live="polite"></p>
    </div>
  </section>

  <section id="panel-validation" class="sb-panel" role="tabpanel" aria-labelledby="tab-validation" aria-hidden="true">
    <div class="sb-section">
      <h3>Run Rule Checks</h3>
      <div class="sb-controls">
        <label><input type="checkbox" id="filter-errors" checked> Errors</label>
        <label><input type="checkbox" id="filter-warnings" checked> Warnings</label>
        <select id="filter-category">
          <option value="">All Categories</option>
          <option value="power">Power</option>
          <option value="data">Data</option>
          <option value="hierarchy">Hierarchy</option>
        </select>
        <button id="action-run-checks" class="sb-tab">Run Checks</button>
      </div>
    </div>
    <div class="sb-section">
      <h4>Results</h4>
      <ul id="validation-results" class="sb-list" aria-live="polite"></ul>
    </div>
  </section>

  <!-- Requirements Panel (Issue #31) -->
  <section id="panel-requirements" class="sb-panel" role="tabpanel" aria-labelledby="tab-requirements" aria-hidden="true">
    <div class="sb-section">
      <h3>Requirements Verification</h3>
      <p style="color:var(--fusion-text-secondary);font-size:11px;margin:0 0 8px 0;">
        Evaluate system-level requirements against block attributes.
      </p>
      <div class="sb-controls">
        <button id="action-validate-reqs" class="sb-tab">Check Requirements</button>
        <span id="reqs-status" class="pill">Not checked</span>
      </div>
    </div>
    <div class="sb-section">
      <h4>Results</h4>
      <table id="reqs-results-table" style="width:100%;border-collapse:collapse;font-size:11px;display:none;">
        <thead>
          <tr style="background:var(--fusion-bg-secondary);">
            <th style="padding:4px 6px;text-align:left;">Status</th>
            <th style="padding:4px 6px;text-align:left;">Requirement</th>
            <th style="padding:4px 6px;text-align:right;">Actual</th>
            <th style="padding:4px 6px;text-align:center;">Op</th>
            <th style="padding:4px 6px;text-align:right;">Target</th>
            <th style="padding:4px 6px;text-align:left;">Unit</th>
          </tr>
        </thead>
        <tbody id="reqs-results-body"></tbody>
      </table>
      <p id="reqs-empty" style="color:var(--fusion-text-secondary);font-size:11px;">
        No requirements defined on this diagram. Add requirements in the block attributes panel.
      </p>
    </div>
  </section>

  <!-- History / Version Control Panel (Issue #31) -->
  <section id="panel-history" class="sb-panel" role="tabpanel" aria-labelledby="tab-history" aria-hidden="true">
    <div class="sb-section">
      <h3>Version History</h3>
      <p style="color:var(--fusion-text-secondary);font-size:11px;margin:0 0 8px 0;">
        Create and manage snapshots of your diagram.
      </p>
      <div class="sb-controls" style="gap:6px;">
        <input type="text" id="snapshot-description" class="fusion-input"
               placeholder="Snapshot description…" style="flex:1;font-size:11px;padding:4px 6px;" />
        <button id="action-create-snapshot" class="sb-tab">Create Snapshot</button>
      </div>
    </div>
    <div class="sb-section">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h4 style="margin:0;">Snapshots</h4>
        <button id="action-refresh-snapshots" class="sb-tab" style="font-size:10px;padding:2px 6px;">Refresh</button>
      </div>
      <ul id="snapshot-list" class="sb-list" style="max-height:200px;overflow-y:auto;" aria-live="polite">
        <li style="color:var(--fusion-text-secondary);font-size:11px;">No snapshots yet.</li>
      </ul>
    </div>
    <div class="sb-section" id="snapshot-compare-section" style="display:none;">
      <h4>Comparison Result</h4>
      <div id="snapshot-diff-result" style="font-size:11px;"></div>
    </div>
  </section>

  <section id="panel-reports" class="sb-panel" role="tabpanel" aria-labelledby="tab-reports" aria-hidden="true">
    <div class="sb-section">
      <h3>Export Reports</h3>
      <p style="color:var(--fusion-text-secondary);font-size:11px;margin:0 0 8px 0;">
        Export your diagram as Markdown, HTML, CSV, BOM, and more.
        Click <strong>Export…</strong> to choose formats and destination.
      </p>
      <div class="sb-controls">
        <button id="action-export" class="sb-tab">Export…</button>
        <span id="export-status" class="pill">Not exported</span>
      </div>
    </div>
    <div class="sb-section">
      <h4>Last Export Output</h4>
      <div id="export-path" class="pill" style="word-break:break-all;">Path: (awaiting export)</div>
      <ul id="export-files" class="sb-list"></ul>
    </div>
  </section>

  <!-- Persistent Status Bar -->
  <footer class="sb-status" role="status" aria-live="polite">
    <button id="action-save" class="sb-tab">Save</button>
    <label><input type="checkbox" id="toggle-autosave"> Autosave</label>
    <span id="status-health" class="pill">Health: Unknown</span>
    <span id="status-last-saved" class="pill">Last saved: never</span>
    <span id="status-conn" class="pill">Bridge: checking…</span>
  </footer>
  
  <!-- Modular JavaScript Architecture -->
  <script src="./types/bridge-actions.js"></script>
  <script src="./utils/logger.js"></script>
  <script src="./utils/delta-utils.js"></script>
  <script src="./core/diagram-editor.js"></script>
  <script src="./core/orthogonal-router.js"></script>
  <script src="./ui/diagram-renderer.js"></script>
  <script src="./ui/minimap.js"></script>
  <script src="./ui/toolbar-manager.js"></script>
  <script src="./features/advanced-features.js"></script>
  <script src="./interface/python-bridge.js"></script>
  <script src="./ui/palette-tabs.js"></script>
  <script src="./main-coordinator.js"></script>
  <script src="./palette.js"></script>

  <!-- Fallback button handler for Fusion 360 webview compatibility -->
  <script>
    (function() {
      'use strict';

      // ── Only activate fallback if the modular system did NOT load ──
      // The modular coordinator sets window._systemBlocksInitialized = true
      // once all modules are wired up. If that flag is already set we can
      // skip standalone state entirely. For the brief window before init
      // completes, individual handlers also check window.diagramEditor.
      if (window._systemBlocksInitialized) {
        console.log('Modular system loaded — skipping fallback handlers');
        return;
      }

      // Shared diagram state — only used when the modular system is absent
      window.standaloneDiagram = window.standaloneDiagram || {
        blocks: [],
        connections: [],
        nextId: 1,
        selectedBlockId: null
      };

      // Helper: Show toast notification
      function showToast(message, type) {
        type = type || 'info';
        var toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = 'position:fixed;bottom:60px;left:50%;transform:translateX(-50%);' +
          'padding:12px 24px;border-radius:6px;color:white;font-size:14px;z-index:99999;' +
          'pointer-events:none;transition:opacity 0.3s;' +
          'background:' + (type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3');
        document.body.appendChild(toast);
        setTimeout(function() {
          toast.style.opacity = '0';
          setTimeout(function() { toast.remove(); }, 300);
        }, 3000);
      }

      // ── Fallback actions for buttons NOT YET handled by the modular system ──
      var fallbackActions = {
        'btn-add-first-block': function() {
          // The welcome-screen "Add your first block" button.
          // Prefer the modular editor when available.
          if (window.diagramEditor && window.diagramRenderer) {
            var block = window.diagramEditor.addBlock({
              name: 'Block 1',
              type: 'Generic',
              x: 200,
              y: 200
            });
            window.diagramRenderer.renderBlock(block);
            showToast('Block added: ' + block.name, 'success');
          } else if (!window._systemBlocksInitialized) {
            addStandaloneBlock();
          }
          // Hide the empty-state overlay
          var empty = document.getElementById('empty-canvas-state');
          if (empty) empty.style.display = 'none';
        },

        'btn-go-up': function() {
          if (window._systemBlocksInitialized) return; // handled by modular toolbar
          showToast('Navigate Up: No parent diagram', 'info');
        },

        'btn-drill-down': function() {
          if (window._systemBlocksInitialized) return;
          showToast('Drill Down: Select a block first', 'info');
        },

        'btn-create-child': function() {
          if (window._systemBlocksInitialized) return;
          showToast('Create Child: Select a block first', 'info');
        },

        'btn-snap-grid': function() {
          if (window._systemBlocksInitialized) return;
          var btn = document.getElementById('btn-snap-grid');
          if (btn) btn.classList.toggle('active');
          if (window.diagramEditor) {
            window.diagramEditor.snapToGridEnabled = !window.diagramEditor.snapToGridEnabled;
          }
          showToast('Grid snap ' + (btn && btn.classList.contains('active') ? 'ON' : 'OFF'), 'info');
        },

        'btn-import': function() {
          if (window._systemBlocksInitialized) return;
          showToast('Import: Coming soon', 'info');
        }
      };

      // ── Standalone block creation (safety net if modular system fails) ──
      function addStandaloneBlock() {
        var id = 'block-' + (window.standaloneDiagram.nextId++);
        var block = {
          id: id,
          name: 'Block ' + window.standaloneDiagram.nextId,
          type: 'Generic',
          x: 100 + Math.random() * 300,
          y: 100 + Math.random() * 200,
          width: 120,
          height: 80
        };
        window.standaloneDiagram.blocks.push(block);
        createBlockElement(block);
        showToast('Block added: ' + block.name, 'success');
      }

      function createBlockElement(block) {
        var svg = document.getElementById('svg-canvas');
        if (!svg) return null;

        var blocksGroup = svg.querySelector('#blocks-layer');
        if (!blocksGroup) {
          blocksGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          blocksGroup.id = 'blocks-layer';
          svg.appendChild(blocksGroup);
        }

        var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('id', block.id);
        g.setAttribute('class', 'diagram-block');
        g.setAttribute('transform', 'translate(' + block.x + ',' + block.y + ')');
        g.style.cursor = 'move';

        var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('width', block.width);
        rect.setAttribute('height', block.height);
        rect.setAttribute('rx', '6');
        rect.setAttribute('fill', '#3d3d3d');
        rect.setAttribute('stroke', '#0078d4');
        rect.setAttribute('stroke-width', '2');
        g.appendChild(rect);

        var text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', block.width / 2);
        text.setAttribute('y', block.height / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#ffffff');
        text.setAttribute('font-size', '12');
        text.setAttribute('font-family', 'Artifakt Element, sans-serif');
        text.textContent = block.name;
        g.appendChild(text);

        var typeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        typeText.setAttribute('x', block.width / 2);
        typeText.setAttribute('y', block.height / 2 + 16);
        typeText.setAttribute('text-anchor', 'middle');
        typeText.setAttribute('fill', '#888888');
        typeText.setAttribute('font-size', '10');
        typeText.textContent = block.type;
        g.appendChild(typeText);

        blocksGroup.appendChild(g);
        makeDraggable(g, block);
        return g;
      }

      function makeDraggable(element, block) {
        var isDragging = false;
        var startX, startY, origX, origY;

        element.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
          origX = block.x;
          origY = block.y;
          element.style.opacity = '0.8';
          e.stopPropagation();
        });

        document.addEventListener('mousemove', function(e) {
          if (!isDragging) return;
          var dx = e.clientX - startX;
          var dy = e.clientY - startY;
          block.x = origX + dx;
          block.y = origY + dy;
          element.setAttribute('transform', 'translate(' + block.x + ',' + block.y + ')');
        });

        document.addEventListener('mouseup', function() {
          if (isDragging) {
            isDragging = false;
            element.style.opacity = '1';
          }
        });
      }

      function getExportData() {
        if (window.diagramEditor && window.diagramEditor.diagram) {
          return JSON.stringify(window.diagramEditor.diagram);
        }
        return JSON.stringify(window.standaloneDiagram);
      }

      // ── Thin delegation listener (only fires for unhandled buttons) ──
      document.addEventListener('click', function(e) {
        var button = e.target.closest('button[id^="btn-"], button[id^="action-"]');
        if (!button) return;

        var buttonId = button.id;

        // If the modular ToolbarManager already handled this via
        // stopPropagation, we won't reach here for those buttons.
        // This handler catches only the buttons not wired by the modules.
        if (fallbackActions[buttonId]) {
          // Visual press feedback
          button.style.transform = 'scale(0.95)';
          setTimeout(function() { button.style.transform = ''; }, 100);

          try {
            fallbackActions[buttonId]();
          } catch (err) {
            console.error('Fallback action error:', err);
            showToast('Error: ' + err.message, 'error');
          }
        }
      }); // bubble phase — runs AFTER modular handlers

      console.log('Fallback button handlers initialized');
    })();
  </script>

</body>
</html>
